#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# NTX Quest Radar V4.0
# - ä½¿ç”¨ Galxe Open API
# - å¡ç‰‡åªæ˜¾ç¤ºï¼šå¼€å§‹æ—¶é—´ / ç»“æŸæ—¶é—´ / æ´»åŠ¨çŠ¶æ€ï¼ˆæœªå¼€å§‹ / è¿›è¡Œä¸­ / å·²ç»“æŸï¼‰
# - åˆ é™¤â€œåˆ›å»ºæ—¶é—´â€æ˜¾ç¤ºï¼Œé¿å…æ— æ„ä¹‰çš„ "-"
# - é¡¶éƒ¨å¯¼èˆª + æ›´ç°ä»£çš„å¡ç‰‡å¸ƒå±€
# - æ”¯æŒé¡¹ç›®ç®¡ç†ï¼ˆå•ä¸ªæ·»åŠ  / æ‰¹é‡å¯¼å…¥ / åˆ é™¤ï¼‰
# - æ”¯æŒ Telegram / Discord æ¨é€ + æµ‹è¯•é€šçŸ¥

import json
import os
import threading
import time
from datetime import datetime, timezone, timedelta

import requests
from flask import Flask, request

ROOT = "/opt/GalxeMonitor"
CONFIG_PATH = os.path.join(ROOT, "config.json")
STATE_PATH = os.path.join(ROOT, "monitor_state.json")
OPENAPI_URL = "https://graphigo.prd.galaxy.eco/query"

last_notified = {}  # alias -> last campaign id


# =============== é…ç½®ç®¡ç† ===============

def ensure_config():
    if not os.path.exists(CONFIG_PATH):
        cfg = {
            "webui_port": 5001,
            "webui_password": "admin",
            "notify_method": "none",          # none / telegram / discord / both
            "telegram_bot_token": "",
            "telegram_chat_id": "",
            "discord_webhook_url": "",
            "projects": [
                {"name": "BNB Chain", "alias": "bnbchain", "category": "trending"},
                {"name": "Galxe Official", "alias": "Galxe", "category": "trending"},
                {"name": "OKX Web3", "alias": "okxweb3", "category": "trending"},
                {"name": "Zaiffer Quest", "alias": "Zaiffer", "category": "trending"},
            ],
        }
        with open(CONFIG_PATH, "w", encoding="utf-8") as f:
            json.dump(cfg, f, indent=2, ensure_ascii=False)


def load_config():
    with open(CONFIG_PATH, "r", encoding="utf-8") as f:
        return json.load(f)


def save_config(cfg):
    with open(CONFIG_PATH, "w", encoding="utf-8") as f:
        json.dump(cfg, f, indent=2, ensure_ascii=False)


def write_state(state):
    try:
        with open(STATE_PATH, "w", encoding="utf-8") as f:
            json.dump(state, f, indent=2, ensure_ascii=False)
    except Exception as e:
        print("[å†™å…¥ monitor_state.json å¤±è´¥]:", e)


# =============== OpenAPI ===============

QUERY_LATEST_SAFE = """
query LatestSafe($alias:String!){
  space(alias:$alias){
    id
    name
    alias
    campaigns(input:{}){
      list{
        id
        name
        createdAt
        startTime
        endTime
      }
    }
  }
}
"""


def fetch_latest(alias):
    try:
        r = requests.post(
            OPENAPI_URL,
            json={"query": QUERY_LATEST_SAFE, "variables": {"alias": alias}},
            timeout=15,
        )
        data = r.json()
        if "errors" in data:
            print("[OpenAPI é”™è¯¯]", alias, data["errors"])
            return None

        space = data.get("data", {}).get("space")
        if not space:
            return None

        lst = space.get("campaigns", {}).get("list", [])
        latest = lst[0] if lst else None
        return {"space": space, "latest": latest}
    except Exception as e:
        print("[è¯·æ±‚å¤±è´¥]", alias, e)
        return None


def _extract_campaign_id(latest):
    if not latest:
        return None

    def gx(obj, key):
        if isinstance(obj, dict):
            return obj.get(key)
        return getattr(obj, key, None)

    for k in ("id", "campaignId", "campaignID", "hashId", "slug"):
        v = gx(latest, k)
        if v:
            return v
    return None


def build_campaign_url(alias, latest):
    if not alias or not latest:
        return None
    cid = _extract_campaign_id(latest)
    if not cid:
        return None
    # ä½¿ç”¨ /quest/alias/campaignId æ ¼å¼ï¼Œè§„é¿ 404
    return "https://app.galxe.com/quest/{}/{}".format(alias, cid)


# =============== æ—¶é—´ä¸çŠ¶æ€å¤„ç† ===============

def _fmt_time(t):
    """æŠŠæ—¶é—´æˆ³ / ISO å­—ç¬¦ä¸²è½¬æˆ åŒ—äº¬æ—¶é—´ï¼Œå¯è¯»æ ¼å¼ã€‚"""
    if not t:
        return "-"

    CST = timezone(timedelta(hours=8))

    # ç›´æ¥æ˜¯ datetime
    if isinstance(t, datetime):
        return t.astimezone(CST).strftime("%Y-%m-%d %H:%M:%S")

    # æ•°å­—ï¼ˆæ—¶é—´æˆ³ï¼‰
    try:
        if isinstance(t, (int, float)):
            ts = float(t)
        elif isinstance(t, str):
            s = t.strip()
            if s.isdigit():
                ts = float(s)
            else:
                # å°è¯•å½“ ISO æ ¼å¼è§£æ
                try:
                    dt = datetime.fromisoformat(s.replace("Z", "+00:00"))
                    return dt.astimezone(CST).strftime("%Y-%m-%d %H:%M:%S")
                except Exception:
                    return s
        else:
            return str(t)

        if ts > 1e12:  # æ¯«ç§’çº§
            ts = ts / 1000.0
        dt = datetime.fromtimestamp(ts, tz=CST)
        return dt.strftime("%Y-%m-%d %H:%M:%S")
    except Exception:
        return str(t)


def _parse_ts(t):
    """æŠŠå„ç§æ—¶é—´å½¢å¼ç»Ÿä¸€æˆ UTC datetimeï¼Œå¤±è´¥è¿”å› Noneã€‚"""
    if not t:
        return None
    if isinstance(t, datetime):
        if t.tzinfo is None:
            return t.replace(tzinfo=timezone.utc)
        return t.astimezone(timezone.utc)
    try:
        if isinstance(t, (int, float)):
            ts = float(t)
        elif isinstance(t, str):
            s = t.strip()
            if s.isdigit():
                ts = float(s)
            else:
                # ISO
                try:
                    dt = datetime.fromisoformat(s.replace("Z", "+00:00"))
                    if dt.tzinfo is None:
                        dt = dt.replace(tzinfo=timezone.utc)
                    return dt.astimezone(timezone.utc)
                except Exception:
                    return None
        else:
            return None

        if ts > 1e12:
            ts = ts / 1000.0
        return datetime.fromtimestamp(ts, tz=timezone.utc)
    except Exception:
        return None



def _build_status(latest):
    """æ ¹æ® startTime / endTime è®¡ç®—çŠ¶æ€ï¼šæœªå¼€å§‹ / è¿›è¡Œä¸­ / å·²ç»“æŸ / æœªçŸ¥ã€‚"""
    if not latest:
        return "ğŸŸ  æœªçŸ¥"

    now = datetime.utcnow().replace(tzinfo=timezone.utc)
    start = _parse_ts(latest.get("startTime"))
    end = _parse_ts(latest.get("endTime"))

    if start and now < start:
        return "â³ æœªå¼€å§‹"
    if end and now > end:
        return "ğŸ”´ å·²ç»“æŸ"
    if start and (not end or start <= now <= end):
        return "âœ… è¿›è¡Œä¸­"

    return "ğŸŸ  æœªçŸ¥"


    now = datetime.utcnow().replace(tzinfo=timezone.utc)
    start = _parse_ts(latest.get("startTime"))
    end = _parse_ts(latest.get("endTime"))

    if start and now < start:
        return "â³ æœªå¼€å§‹"
    if end and now > end:
        return "âš ï¸ å·²ç»“æŸ"
    if start and (not end or start <= now <= end):
        return "âœ… è¿›è¡Œä¸­"
    return "æœªçŸ¥"


# =============== æ¨é€é€šçŸ¥ ===============

def _build_notify_text(project_name, alias, latest, url):
    title = (latest or {}).get("name") or "(æ— æ ‡é¢˜æ´»åŠ¨)"
    start = _fmt_time(latest.get("startTime")) if latest else "-"
    end = _fmt_time(latest.get("endTime")) if latest else "-"
    status = _build_status(latest)

    lines = [
        "ã€NTX Quest Radarã€‘å‘ç°æ–°æ´»åŠ¨",
        "é¡¹ç›®ï¼š{} (@{})".format(project_name, alias),
        "æ´»åŠ¨ï¼š{}".format(title),
        "çŠ¶æ€ï¼š{}".format(status),
        "å¼€å§‹æ—¶é—´ï¼š{}".format(start),
        "ç»“æŸæ—¶é—´ï¼š{}".format(end),
        "é“¾æ¥ï¼š{}".format(url or "-"),
    ]
    return "\n".join(lines)


def send_telegram(cfg, text):
    token = cfg.get("telegram_bot_token") or ""
    chat_id = cfg.get("telegram_chat_id") or ""
    if not token or not chat_id:
        return
    try:
        url = "https://api.telegram.org/bot{}/sendMessage".format(token)
        requests.post(url, data={"chat_id": chat_id, "text": text}, timeout=10)
    except Exception as e:
        print("[Telegram æ¨é€å¤±è´¥]", e)


def send_discord(cfg, text):
    webhook = cfg.get("discord_webhook_url") or ""
    if not webhook:
        return
    try:
        requests.post(webhook, json={"content": text}, timeout=10)
    except Exception as e:
        print("[Discord æ¨é€å¤±è´¥]", e)


def send_notifications(cfg, project_name, alias, latest, url):
    method = (cfg.get("notify_method") or "none").lower()
    if method == "none":
        return
    text = _build_notify_text(project_name, alias, latest, url)
    if method in ("telegram", "both"):
        send_telegram(cfg, text)
    if method in ("discord", "both"):
        send_discord(cfg, text)


# =============== ç›‘æ§ä¸»å¾ªç¯ ===============

monitor_state = {"last_loop": "", "projects": []}


def monitor_loop():
    global monitor_state, last_notified
    first_loop = True

    while True:
        cfg = load_config()
        out = []

        for p in cfg.get("projects", []):
            alias = p.get("alias")
            name = p.get("name", alias)
            cat = p.get("category", "custom")

            info = fetch_latest(alias)
            latest = info["latest"] if info else None
            url = build_campaign_url(alias, latest)

            out.append(
                {
                    "name": name,
                    "alias": alias,
                    "category": cat,
                    "latest": latest,
                    "url": url,
                }
            )

            cid = _extract_campaign_id(latest)
            if not first_loop and cid and latest:
                prev = last_notified.get(alias)
                if prev != cid:
                    send_notifications(cfg, name, alias, latest, url)
                    last_notified[alias] = cid

        monitor_state["last_loop"] = datetime.utcnow().isoformat() + "Z"
        monitor_state["projects"] = out
        write_state(monitor_state)

        first_loop = False
        time.sleep(20)


# =============== Web UI ===============

app = Flask(__name__)


def card_html(p):
    latest = p.get("latest")
    url = p.get("url") or "#"
    cat = p.get("category", "custom")
    tag = "ğŸ”¥ Trending" if cat == "trending" else "â­ Custom"

    if latest:
        title = latest.get("name") or "(æ— æ ‡é¢˜æ´»åŠ¨)"
        start = _fmt_time(latest.get("startTime"))
        end = _fmt_time(latest.get("endTime"))
        status = _build_status(latest)
        if "è¿›è¡Œä¸­" in status:
            css = "pill-running"
        elif "æœªçŸ¥" in status:
            css = "pill-unknown"
        elif "æœªå¼€å§‹" in status:
            css = "pill-upcoming"
        elif "å·²ç»“æŸ" in status:
            css = "pill-ended"
        else:
            css = "pill-active"

        return """
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">{name}</div>
              <div class="card-sub">@{alias} Â· {tag}</div>
            </div>
            <div class="pill">{status}</div>
          </div>
          <div class="card-body">
            <div class="activity-title">
              <span>æœ€æ–°æ´»åŠ¨ï¼š</span>
              <a href="{url}" target="_blank">{title}</a>
            </div>
            <div class="activity-meta">
              <div>å¼€å§‹æ—¶é—´ï¼š{start}</div>
              <div>ç»“æŸæ—¶é—´ï¼š{end}</div>
            </div>
          </div>
        </div>
        """.format(
            name=p["name"],
            alias=p["alias"],
            tag=tag,
            url=url,
            title=title,
            start=start,
            end=end,
            status=status,
        )
    else:
        return """
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">{name}</div>
              <div class="card-sub">@{alias} Â· {tag}</div>
            </div>
            <div class="pill pill-empty">æš‚æ— æ´»åŠ¨</div>
          </div>
          <div class="card-body">
            <div class="activity-title">å½“å‰æ²¡æœ‰å¯è§æ´»åŠ¨æˆ–æ‹‰å–å¤±è´¥ã€‚</div>
          </div>
        </div>
        """.format(
            name=p["name"],
            alias=p["alias"],
            tag=tag,
        )


@app.route("/")
def index():
    cfg = load_config()
    pwd = request.args.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    q = (request.args.get("q") or "").lower()
    cat = (request.args.get("cat") or "all").lower()

    projs = monitor_state.get("projects", [])

    if q:
        filtered = []
        for p in projs:
            if q in (p.get("name", "").lower()) or q in (p.get("alias", "").lower()):
                filtered.append(p)
        projs = filtered

    if cat in ("custom", "trending"):
        projs = [p for p in projs if p.get("category") == cat]

    # === NTX è‡ªå®šä¹‰æ’åºï¼šè¿›è¡Œä¸­ / æœ‰æ•ˆæ´»åŠ¨åœ¨å‰ï¼Œå·²ç»“æŸå’Œæ— æ•ˆåœ¨å ===
    def _ntx_sort_key(p):
        status = (p.get("latest_status") or "").strip()

        # æŒ‰çŠ¶æ€åˆ†å±‚ï¼š
        # 0: è¿›è¡Œä¸­ / æœ‰æ–°æ´»åŠ¨
        # 1: å·²ç»“æŸ
        # 2: æš‚æ— æ´»åŠ¨ / æ‹‰å–å¤±è´¥ / å…¶å®ƒå¼‚å¸¸
        rank = 2
        if any(x in status for x in ("è¿›è¡Œä¸­", "æœ‰æœ€æ–°æ´»åŠ¨", "æœ€æ–°æ´»åŠ¨")):
            rank = 0
        elif "å·²ç»“æŸ" in status:
            rank = 1
        elif any(x in status for x in ("æš‚æ— æ´»åŠ¨", "æ‹‰å–å¤±è´¥", "æŠ“å–å¤±è´¥")):
            rank = 2

        latest = p.get("latest") or {}
        # Galxe è¿”å›çš„ä¸€èˆ¬æ˜¯ç§’çº§æ—¶é—´æˆ³ï¼Œè¿™é‡Œç»Ÿä¸€æˆ int æ–¹ä¾¿æ¯”è¾ƒ
        def _to_int(v):
            try:
                return int(v)
            except Exception:
                return 0

        start_ts = _to_int(latest.get("startTime") or 0)
        created_ts = _to_int(latest.get("createdAt") or 0)
        # æ—¶é—´è¶Šæ–°è¶Šé å‰ï¼Œæ‰€ä»¥å–è´Ÿæ•°
        ts = max(start_ts, created_ts)

        return (rank, -ts)

    def _ntx_status_group(p):
        latest = p.get("latest") or {}
        status = _build_status(latest) or ""
        if "è¿›è¡Œä¸­" in status:
            return 0
        if ("æœªå¼€å§‹" in status) or ("å³å°†å¼€å§‹" in status):
            return 1
        if "å·²ç»“æŸ" in status or "ç»“æŸ" in status:
            return 2
        return 3

    sorted_projs = sorted(
        projs,
        key=lambda p: (
            _ntx_status_group(p),
            0 if p.get("category") == "trending" else 1,
            -int((p.get("latest") or {}).get("startTime") or 0),
            p.get("name", "").lower(),
        ),
    )
    cards = "".join(card_html(p) for p in sorted_projs)
    last = monitor_state.get("last_loop", "")

    active_all = "active" if cat == "all" else ""
    active_custom = "active" if cat == "custom" else ""
    active_trending = "active" if cat == "trending" else ""

    html = """
    <html>
    <head>
      <meta charset="utf-8" />
      <title>NTX Quest Radar æ§åˆ¶å°</title>
      <style>
        body {{
          margin: 0;
          padding: 0;
          background: #020617;
          color: #e5e7eb;
          font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
        }}
        .shell {{
          min-height: 100vh;
          background: radial-gradient(circle at top left,#0b1120 0,#020617 45%);
        }}
        .container {{
          max-width: 1100px;
          margin: 0 auto;
          padding: 20px 16px 40px;
        }}
        .top-nav {{
          display:flex;
          justify-content:space-between;
          align-items:center;
          margin-bottom:12px;
        }}
        .brand {{
          font-size:20px;
          font-weight:600;
        }}
        .brand span {{
          font-size:11px;
          color:#9ca3af;
          margin-left:6px;
        }}
        .nav-links a {{
          font-size:13px;
          margin-left:10px;
          color:#9ca3af;
          text-decoration:none;
          padding:4px 10px;
          border-radius:999px;
          border:1px solid transparent;
        }}
        .nav-links a.active {{
          color:#e5e7eb;
          border-color:#1d4ed8;
          background:#1d4ed833;
        }}
        .subtitle {{
          font-size:13px;
          color: #9ca3af;
          margin-bottom: 14px;
        }}
        .top-bar {{
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          align-items: center;
          margin-bottom: 16px;
        }}
        .pill-info {{
          border-radius: 999px;
          padding: 4px 12px;
          font-size: 12px;
          border: 1px solid #1f2937;
          background:#020617;
          color:#9ca3af;
        }}
        .pill-info strong {{
          color:#e5e7eb;
        }}
        .search-box input {{
          background: #020617;
          border-radius: 999px;
          border: 1px solid #1f2937;
          padding: 6px 12px;
          color: #e5e7eb;
          outline: none;
          min-width: 180px;
        }}
        .search-box button {{
          margin-left: 6px;
          border-radius: 999px;
          border: 1px solid #374151;
          background: #111827;
          color: #e5e7eb;
          padding: 6px 12px;
          cursor: pointer;
        }}
        .filters a {{
          font-size: 13px;
          padding: 4px 10px;
          border-radius: 999px;
          border: 1px solid #1f2937;
          color: #9ca3af;
          text-decoration: none;
          margin-right: 6px;
        }}
        .filters a.active {{
          background: #2563eb;
          border-color: #2563eb;
          color: #e5e7eb;
        }}
        .actions a {{
          font-size: 12px;
          padding: 5px 10px;
          border-radius: 999px;
          border: 1px solid #4b5563;
          color: #e5e7eb;
          text-decoration: none;
        }}
        .actions a.primary {{
          background:#10b981;
          border-color:#10b981;
          color:#022c22;
          font-weight:600;
        }}
        .grid {{
          display: grid;
          grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
          gap: 14px;
          margin-top: 10px;
        }}
        .card {{
          background: radial-gradient(circle at top left,#111827 0,#020617 55%);
          border-radius: 14px;
          border: 1px solid #111827;
          padding: 12px 14px 12px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.45);
        }}
        .card-header {{
          display:flex;
          justify-content:space-between;
          align-items:center;
          margin-bottom:8px;
        }}
        .card-title {{
          font-size:15px;
          font-weight:600;
        }}
        .card-sub {{
          font-size:11px;
          color:#9ca3af;
          margin-top:2px;
        }}
        .pill {{
          border-radius:999px;
          padding:3px 8px;
          font-size:11px;
          border:1px solid #22c55e;
        }}
        .pill-active {{
          background:#16a34a33;
          border-color:#22c55e;
          color:#bbf7d0;
        }}
        .pill-empty {{
          background:#33415555;
          border-color:#64748b;
          color:#e5e7eb;
        }}
        .activity-title {{
          font-size:13px;
          margin-bottom:4px;
        }}
        .activity-title a {{
          color:#60a5fa;
          text-decoration:none;
        }}
        .activity-title a:hover {{
          text-decoration:underline;
        }}
        .activity-meta {{
          font-size:11px;
          color:#9ca3af;
        }}
        @media (max-width:640px) {{
          .top-bar {{
            flex-direction:column;
            align-items:flex-start;
          }}
          .top-nav {{
            flex-direction:column;
            align-items:flex-start;
            gap:4px;
          }}
        }}
      </style>
    </head>
    <body>
      <div class="shell">
        <div class="container">

          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;margin-bottom:18px;">
            <div style="display:flex;align-items:center;gap:12px;">
              <div style="width:40px;height:40px;border-radius:999px;background:radial-gradient(circle at 30% 20%,#34d399 0,#059669 40%,#022c22 100%);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;letter-spacing:.5px;">
                NTX
              </div>
              <div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                  <span style="font-size:20px;font-weight:600;">NTX Quest Radar</span>
                  <span style="font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #1d4ed8;background:#1d4ed822;color:#bfdbfe;">OpenAPI Â· V4.0</span>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;font-size:11px;color:#9ca3af;">
                  <span style="padding:2px 8px;border-radius:999px;border:1px solid #1f2937;background:#020617;">å…¬å¼€ API æ¨¡å¼</span>
                  <span style="padding:2px 8px;border-radius:999px;border:1px dashed #1f2937;background:#020617;">ä¸ä¾èµ– Space Owner æƒé™</span>
                </div>
              </div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;font-size:12px;color:#9ca3af;">
              <div><span style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,0.18);margin-right:4px;"></span>è¿è¡Œæ­£å¸¸</div>
              <div>æœ€ååˆ·æ–°ï¼š{last}</div>
              <div>ç™»å½•å¯†ç ï¼š<code style="padding:2px 6px;border-radius:6px;background:#020617;border:1px solid #1f2937;color:#e5e7eb;font-size:11px;">{pwd}</code></div>
              <div>
                <a href="/?pwd={pwd}" style="font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid #2563eb;background:#2563eb;color:#e5e7eb;text-decoration:none;margin-right:6px;">æ´»åŠ¨ç›‘æ§</a>
                <a href="/manage?pwd={pwd}" style="font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid #334155;color:#9ca3af;text-decoration:none;" target="_blank">é¡¹ç›®ç®¡ç†</a>
              </div>
            </div>
          </div>

          <div class="top-bar">
            <div class="pill-info">ç™»å½•å¯†ç ï¼š<strong>{pwd}</strong></div>

            <form class="search-box" method="GET" action="/">
              <input type="hidden" name="pwd" value="{pwd}">
              <input type="text" name="q" placeholder="æœç´¢ Space åç§°æˆ– aliasâ€¦" value="{q}">
              <button type="submit">æœç´¢</button>
            </form>

            <div class="filters">
              <a href="/?pwd={pwd}&cat=all" class="{active_all}">å…¨éƒ¨</a>
              <a href="/?pwd={pwd}&cat=custom" class="{active_custom}">è‡ªå®šä¹‰</a>
              <a href="/?pwd={pwd}&cat=trending" class="{active_trending}">çƒ­åº¦Top</a>
            </div>

            <div class="actions">
              <a href="/manage?pwd={pwd}" class="primary">é¡¹ç›®ç®¡ç†</a>
            </div>
          </div>

          <div class="grid">
            {cards}
          </div>

        </div>
      </div>
    </body>
    </html>
    """.format(
        last=last,
        pwd=cfg["webui_password"],
        q=q,
        active_all=active_all,
        active_custom=active_custom,
        active_trending=active_trending,
        cards=cards
        or '<div style="color:#9ca3af;font-size:13px;">å½“å‰æ²¡æœ‰ä»»ä½•é¡¹ç›®ã€‚</div>',
    )
    return html


@app.route("/manage")
def manage():
    cfg = load_config()
    pwd = request.args.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    rows = ""
    for i, p in enumerate(cfg.get("projects", [])):
        name = p.get("name", "")
        alias = p.get("alias", "")
        cat = p.get("category", "custom")
        rows += "<tr><td>{}</td><td>{}</td><td>{}</td><td>{}</td></tr>".format(
            i, name, alias, cat
        )

    if not rows:
        rows = '<tr><td colspan="4">æš‚æ— é¡¹ç›®ï¼Œè¯·åœ¨ä¸Šæ–¹æ“ä½œé¢æ¿ä¸­æ·»åŠ ã€‚</td></tr>'

    method = (cfg.get("notify_method") or "none").lower()
    tg_bot = cfg.get("telegram_bot_token", "")
    tg_chat = cfg.get("telegram_chat_id", "")
    discord = cfg.get("discord_webhook_url", "")

    sel_none = "selected" if method == "none" else ""
    sel_tg = "selected" if method == "telegram" else ""
    sel_dc = "selected" if method == "discord" else ""
    sel_both = "selected" if method == "both" else ""

    html = """
    <html>
    <head>
      <meta charset="utf-8" />
      <title>NTX Quest Radar Â· é¡¹ç›®ç®¡ç†</title>
      <style>
        body {{
          margin: 0;
          padding: 0;
          background: #020617;
          color: #e5e7eb;
          font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
        }}
        .shell {{
          min-height:100vh;
          background: radial-gradient(circle at top left,#0b1120 0,#020617 45%);
        }}
        .container {{
          max-width: 960px;
          margin: 0 auto;
          padding: 20px 16px 40px;
        }}
        .top-nav {{
          display:flex;
          justify-content:space-between;
          align-items:center;
          margin-bottom:12px;
        }}
        .brand {{
          font-size:20px;
          font-weight:600;
        }}
        .brand span {{
          font-size:11px;
          color:#9ca3af;
          margin-left:6px;
        }}
        .nav-links a {{
          font-size:13px;
          margin-left:10px;
          color:#9ca3af;
          text-decoration:none;
          padding:4px 10px;
          border-radius:999px;
          border:1px solid transparent;
        }}
        .nav-links a.active {{
          color:#e5e7eb;
          border-color:#1d4ed8;
          background:#1d4ed833;
        }}
        .subtitle {{
          font-size:13px;
          color: #9ca3af;
          margin-bottom: 14px;
        }}
        a {{ color:#60a5fa; text-decoration:none; }}
        a:hover {{ text-decoration:underline; }}
        .card {{
          background: radial-gradient(circle at top left,#111827 0,#020617 55%);
          border-radius: 14px;
          border: 1px solid #111827;
          padding: 14px 16px 16px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.45);
          margin-bottom: 14px;
        }}
        .card-header {{
          display:flex;
          justify-content:space-between;
          align-items:center;
          margin-bottom:10px;
        }}
        .card-title {{
          font-size:15px;
          font-weight:600;
        }}
        .pill-back {{
          border-radius:999px;
          padding:4px 10px;
          font-size:12px;
          border:1px solid #374151;
          background:#020617;
        }}
        table {{
          width: 100%;
          border-collapse: collapse;
          font-size: 13px;
        }}
        th, td {{
          border-bottom: 1px solid #1f2937;
          padding: 6px 8px;
          text-align: left;
          white-space: nowrap;
        }}
        th {{
          font-weight:500;
          color:#9ca3af;
          background:#020617;
        }}
        tr:hover td {{
          background:#020617;
        }}
        .form-row {{
          display:flex;
          flex-wrap:wrap;
          gap:8px;
          align-items:center;
          margin-top:8px;
        }}
        .form-row label {{
          font-size:12px;
          color:#9ca3af;
        }}
        .form-row input, .form-row textarea {{
          background:#020617;
          border-radius:8px;
          border:1px solid #1f2937;
          padding:6px 10px;
          color:#e5e7eb;
          font-size:12px;
        }}
        .form-row textarea {{
          width:100%;
          min-height:70px;
          font-family:monospace;
        }}
        .form-row select {{
          background:#020617;
          border-radius:8px;
          border:1px solid #1f2937;
          padding:6px 10px;
          color:#e5e7eb;
          font-size:12px;
        }}
        .btn {{
          border-radius:999px;
          border:1px solid #4b5563;
          background:#111827;
          color:#e5e7eb;
          padding:6px 12px;
          font-size:12px;
          cursor:pointer;
        }}
        .btn-primary {{
          background:#10b981;
          border-color:#10b981;
          color:#022c22;
          font-weight:600;
        }}
        .hint {{
          font-size:11px;
          color:#9ca3af;
          margin-top:4px;
        }}
        @media (max-width:640px) {{
          .form-row {{
            flex-direction:column;
            align-items:flex-start;
          }}
          .top-nav {{
            flex-direction:column;
            align-items:flex-start;
            gap:4px;
          }}
        }}
      </style>
    </head>
    <body>
      <div class="shell">
        <div class="container">

          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;margin-bottom:18px;">
            <div style="display:flex;align-items:center;gap:12px;">
              <div style="width:40px;height:40px;border-radius:999px;background:radial-gradient(circle at 30% 20%,#34d399 0,#059669 40%,#022c22 100%);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;letter-spacing:.5px;">
                NTX
              </div>
              <div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                  <span style="font-size:20px;font-weight:600;">NTX Quest Radar</span>
                  <span style="font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #1d4ed8;background:#1d4ed822;color:#bfdbfe;">OpenAPI Â· V4.0</span>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;font-size:11px;color:#9ca3af;">
                  <span style="padding:2px 8px;border-radius:999px;border:1px solid #1f2937;background:#020617;">å…¬å¼€ API æ¨¡å¼</span>
                  <span style="padding:2px 8px;border-radius:999px;border:1px dashed #1f2937;background:#020617;">ä¸ä¾èµ– Space Owner æƒé™</span>
                </div>
              </div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;font-size:12px;color:#9ca3af;">
              <div><span style="display:inline-block;width:8px;height:8px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,0.18);margin-right:4px;"></span>è¿è¡Œæ­£å¸¸</div>
              <div>æœ€ååˆ·æ–°ï¼š{last}</div>
              <div>ç™»å½•å¯†ç ï¼š<code style="padding:2px 6px;border-radius:6px;background:#020617;border:1px solid #1f2937;color:#e5e7eb;font-size:11px;">{pwd}</code></div>
              <div>
                <a href="/?pwd={pwd}" style="font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid #2563eb;background:#2563eb;color:#e5e7eb;text-decoration:none;margin-right:6px;">æ´»åŠ¨ç›‘æ§</a>
                <a href="/manage?pwd={pwd}" style="font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid #334155;color:#9ca3af;text-decoration:none;" target="_blank">é¡¹ç›®ç®¡ç†</a>
              </div>
            </div>
          </div>

          <div class="top-bar">
            <div class="pill-info">ç™»å½•å¯†ç ï¼š<strong>{pwd}</strong></div>

            <form class="search-box" method="GET" action="/v4">
              <input type="hidden" name="pwd" value="{pwd}">
              <input type="text" name="q" placeholder="æœç´¢ Space åç§°æˆ– aliasâ€¦" value="{q}">
              <button type="submit">æœç´¢</button>
            </form>

            <div class="filters">
              <a href="/v4?pwd={pwd}&cat=all" class="{active_all}">å…¨éƒ¨</a>
              <a href="/v4?pwd={pwd}&cat=custom" class="{active_custom}">è‡ªå®šä¹‰</a>
              <a href="/v4?pwd={pwd}&cat=trending" class="{active_trending}">çƒ­åº¦Top</a>
            </div>

            <div class="actions">
              <a href="/manage?pwd={pwd}" class="primary">é¡¹ç›®ç®¡ç†</a>
            </div>
          </div>

          <div class="grid">
            {cards}
          </div>

        </div>
      </div>
    </body>
    </html>
    """
    return html


# ==== äº§å“åŒ–é¡¶éƒ¨ç‰ˆæœ¬çš„ V4 é¦–é¡µï¼šé‡å†™ /v4 è§†å›¾ ====
@app.route("/v4")
def index_v4():
    cfg = load_config()
    pwd = request.args.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    q = (request.args.get("q") or "").lower()
    cat = (request.args.get("cat") or "all").lower()

    projs = monitor_state.get("projects", []) or []

    # æœç´¢è¿‡æ»¤
    if q:
        filtered = []
        for p in projs:
            if q in (p.get("name", "").lower()) or q in (p.get("alias", "").lower()):
                filtered.append(p)
        projs = filtered

    # åˆ†ç±»è¿‡æ»¤
    if cat in ("custom", "trending"):
        projs = [p for p in projs if p.get("category") == cat]

    # æ’åºï¼ˆå…ˆç”¨ä½ ç°åœ¨çš„é€»è¾‘ï¼Œæœ‰éœ€è¦æˆ‘ä»¬åé¢å†ç»†è°ƒï¼‰
    try:
        sorted_projs = _ntx_sort_projects_v4(projs)
    except Exception:
        sorted_projs = projs

    cards = "".join(card_html(p) for p in sorted_projs)
    last = monitor_state.get("last_loop", "")

    active_all = "active" if cat == "all" else ""
    active_custom = "active" if cat == "custom" else ""
    active_trending = "active" if cat == "trending" else ""

    html = f"""
    <html>
    <head>
      <meta charset="utf-8" />
      <title>NTX Quest Radar Â· OpenAPI V4</title>
      <style>
        body {{
          margin: 0;
          padding: 0;
          background: #020617;
          color: #e5e7eb;
          font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
        }}
        .shell {{
          min-height: 100vh;
          background: radial-gradient(circle at top left,#0b1120 0,#020617 45%);
        }}
        .container {{
          max-width: 1180px;
          margin: 0 auto;
          padding: 20px 20px 40px;
        }}

        /* ===== é¡¶éƒ¨äº§å“åŒº ===== */
        .app-header {{
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          gap: 16px;
          margin-bottom: 18px;
        }}
        .app-brand {{
          display: flex;
          gap: 12px;
          align-items: center;
        }}
        .app-logo {{
          width: 40px;
          height: 40px;
          border-radius: 999px;
          background: radial-gradient(circle at 30% 20%,#34d399 0,#059669 40%,#022c22 100%);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 16px;
          font-weight: 700;
          letter-spacing: .5px;
        }}
        .app-logo span {{
          transform: translateY(1px);
        }}
        .app-title-row {{
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 4px;
        }}
        .app-title {{
          font-size: 20px;
          font-weight: 600;
        }}
        .app-version {{
          font-size: 11px;
          padding: 2px 8px;
          border-radius: 999px;
          border: 1px solid #1d4ed8;
          background: #1d4ed822;
          color: #bfdbfe;
        }}
        .app-subline {{
          display: flex;
          flex-wrap: wrap;
          gap: 6px;
          font-size: 11px;
          color: #9ca3af;
        }}
        .app-badge {{
          padding: 2px 8px;
          border-radius: 999px;
          border: 1px solid #1f2937;
          background: #020617;
        }}
        .app-badge.green {{
          border-color:#16a34a;
          background:#16a34a22;
          color:#bbf7d0;
        }}
        .app-badge.outline {{
          border-style: dashed;
          color:#9ca3af;
        }}

        .app-meta {{
          display: flex;
          flex-direction: column;
          align-items: flex-end;
          gap: 6px;
          font-size: 12px;
          color:#9ca3af;
        }}
        .app-meta-row {{
          display:flex;
          gap:10px;
          align-items:center;
        }}
        .dot {{
          width:8px;
          height:8px;
          border-radius:999px;
          display:inline-block;
          margin-right:4px;
        }}
        .dot.green {{
          background:#22c55e;
          box-shadow:0 0 0 4px rgba(34,197,94,0.18);
        }}
        .app-meta code {{
          padding:2px 6px;
          border-radius:6px;
          background:#020617;
          border:1px solid #1f2937;
          color:#e5e7eb;
          font-size:11px;
        }}
        .app-nav-links {{
          display:flex;
          gap:8px;
        }}
        .app-nav-links a {{
          font-size:12px;
          padding:4px 10px;
          border-radius:999px;
          border:1px solid #334155;
          text-decoration:none;
          color:#9ca3af;
        }}
        .app-nav-links a.active {{
          background:#2563eb;
          border-color:#2563eb;
          color:#e5e7eb;
        }}

        /* ===== é¡¶éƒ¨å·¥å…·æ¡ï¼ˆæœç´¢ + ç­›é€‰ï¼‰ ===== */
        .top-bar {{
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          align-items: center;
          margin-bottom: 18px;
        }}
        .pill-info {{
          border-radius: 999px;
          padding: 4px 12px;
          font-size: 12px;
          border: 1px solid #1f2937;
          background:#020617;
          color:#9ca3af;
        }}
        .pill-info strong {{
          color:#e5e7eb;
        }}
        .search-box {{
          display:flex;
          align-items:center;
        }}
        .search-box input {{
          background: #020617;
          border-radius: 999px;
          border: 1px solid #1f2937;
          padding: 6px 12px;
          color: #e5e7eb;
          outline: none;
          min-width: 220px;
        }}
        .search-box button {{
          margin-left: 6px;
          border-radius: 999px;
          border: 1px solid #374151;
          background: #111827;
          color: #e5e7eb;
          padding: 6px 12px;
          cursor: pointer;
          font-size: 13px;
        }}
        .filters {{
          display:flex;
          gap:6px;
        }}
        .filters a {{
          font-size: 13px;
          padding: 4px 10px;
          border-radius: 999px;
          border: 1px solid #1f2937;
          color: #9ca3af;
          text-decoration: none;
        }}
        .filters a.active {{
          background: #2563eb;
          border-color: #2563eb;
          color: #e5e7eb;
        }}
        .actions a {{
          font-size: 12px;
          padding: 5px 10px;
          border-radius: 999px;
          border: 1px solid #4b5563;
          color: #e5e7eb;
          text-decoration: none;
        }}
        .actions a.primary {{
          background:#10b981;
          border-color:#10b981;
          color:#022c22;
          font-weight:600;
        }}

        /* ===== å¡ç‰‡åŒºåŸŸ ===== */
        .grid {{
          display: grid;
          grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
          gap: 14px;
          margin-top: 8px;
        }}
        .card {{
          background: radial-gradient(circle at top left,#111827 0,#020617 55%);
          border-radius: 14px;
          border: 1px solid #111827;
          padding: 12px 14px 12px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.45);
        }}
        .card-header {{
          display:flex;
          justify-content:space-between;
          align-items:center;
          margin-bottom:8px;
        }}
        .card-title {{
          font-size:15px;
          font-weight:600;
        }}
        .card-sub {{
          font-size:11px;
          color:#9ca3af;
          margin-top:2px;
        }}
        .pill {{
          border-radius:999px;
          padding:3px 8px;
          font-size:11px;
          border:1px solid #22c55e;
        }}
        .pill-empty {{
          background:#33415555;
          border-color:#64748b;
          color:#e5e7eb;
        }}
        .activity-title {{
          font-size:13px;
          margin-bottom:4px;
        }}
        .activity-title a {{
          color:#60a5fa;
          text-decoration:none;
        }}
        .activity-title a:hover {{
          text-decoration:underline;
        }}
        .activity-meta {{
          font-size:11px;
          color:#9ca3af;
        }}

        @media (max-width:640px) {{
          .app-header {{
            flex-direction:column;
            align-items:flex-start;
          }}
          .app-meta {{
            align-items:flex-start;
          }}
          .top-bar {{
            flex-direction:column;
            align-items:flex-start;
          }}
        }}
      </style>
    </head>
    <body>
      <div class="shell">
        <div class="container">

          <div class="app-header">
            <div class="app-brand">
              <div class="app-logo"><span>NTX</span></div>
              <div>
                <div class="app-title-row">
                  <span class="app-title">NTX Quest Radar</span>
                  <span class="app-version">OpenAPI Â· V4.0</span>
                </div>
                <div class="app-subline">
                  <span class="app-badge green">å…¬å¼€ API æ¨¡å¼</span>
                  <span class="app-badge outline">ä¸ä¾èµ– Space Owner æƒé™</span>
                </div>
              </div>
            </div>
            <div class="app-meta">
              <div class="app-meta-row">
                <span class="dot green"></span>è¿è¡Œæ­£å¸¸
              </div>
              <div class="app-meta-row">
                æœ€ååˆ·æ–°ï¼š{last}
              </div>
              <div class="app-meta-row">
                ç™»å½•å¯†ç ï¼š<code>{pwd}</code>
              </div>
              <div class="app-nav-links">
                <a href="/v4?pwd={pwd}" class="active">æ´»åŠ¨ç›‘æ§</a>
                <a href="/manage?pwd={pwd}" target="_blank">é¡¹ç›®ç®¡ç†</a>
              </div>
            </div>
          </div>

          <div class="top-bar">
            <div class="pill-info">Space ç›‘æ§æ€»æ•°ï¼š<strong>{len(projs)}</strong></div>

            <form class="search-box" method="GET" action="/v4">
              <input type="hidden" name="pwd" value="{pwd}">
              <input type="text" name="q" placeholder="æœç´¢ Space åç§°æˆ– aliasâ€¦" value="{q}">
              <button type="submit">æœç´¢</button>
            </form>

            <div class="filters">
              <a href="/v4?pwd={pwd}&cat=all" class="{active_all}">å…¨éƒ¨</a>
              <a href="/v4?pwd={pwd}&cat=custom" class="{active_custom}">è‡ªå®šä¹‰</a>
              <a href="/v4?pwd={pwd}&cat=trending" class="{active_trending}">çƒ­åº¦Top</a>
            </div>

            <div class="actions">
              <a href="/manage?pwd={pwd}" class="primary" target="_blank">æ‰“å¼€é¡¹ç›®ç®¡ç†</a>
            </div>
          </div>

          <div class="grid">
            {cards}
          </div>

        </div>
      </div>
    </body>
    </html>
    """
    return html

