#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# Galxe Monitor V3.7 â€” çº¯å‡€ç‰ˆï¼ˆæ­£ç¡®æ´»åŠ¨é“¾æ¥ + å¡ç‰‡ UI + ç®¡ç†é¢æ¿ï¼‰

import json
import os
import threading
import time
from datetime import datetime

import requests
from flask import Flask, request

ROOT = "/opt/GalxeMonitor"
CONFIG_PATH = os.path.join(ROOT, "config.json")
STATE_PATH = os.path.join(ROOT, "monitor_state.json")
OPENAPI_URL = "https://graphigo.prd.galaxy.eco/query"


# =============== é…ç½®ç®¡ç† ===============

def ensure_config():
    """å¦‚æœæ²¡æœ‰ config.jsonï¼Œåˆ™åˆ›å»ºä¸€ä¸ªåŸºç¡€é…ç½®ï¼›å¦‚æœå·²ç»å­˜åœ¨ï¼Œåˆ™ä¸è¦†ç›–ã€‚"""
    if not os.path.exists(CONFIG_PATH):
        cfg = {
            "webui_port": 5001,
            "webui_password": "admin",
            "projects": [
                {"name": "BNB Chain", "alias": "bnbchain", "category": "trending"},
                {"name": "Galxe Official", "alias": "Galxe", "category": "trending"},
                {"name": "OKX Web3", "alias": "okxweb3", "category": "custom"},
                {"name": "Zaiffer Quest", "alias": "Zaiffer", "category": "custom"}
            ]
        }
        with open(CONFIG_PATH, "w", encoding="utf-8") as f:
            json.dump(cfg, f, indent=2, ensure_ascii=False)


def load_config():
    with open(CONFIG_PATH, "r", encoding="utf-8") as f:
        return json.load(f)


def save_config(cfg):
    with open(CONFIG_PATH, "w", encoding="utf-8") as f:
        json.dump(cfg, f, indent=2, ensure_ascii=False)


def write_state(state):
    try:
        with open(STATE_PATH, "w", encoding="utf-8") as f:
            json.dump(state, f, indent=2, ensure_ascii=False)
    except Exception as e:
        print("[å†™å…¥ monitor_state.json å¤±è´¥]:", e)


# =============== OpenAPI æŸ¥è¯¢ ===============

# æˆ‘ä»¬å·²ç»éªŒè¯è¿‡è¿™ä¸€ç‰ˆ schemaï¼šspace(alias) + campaigns(input:{}) + list{id name createdAt}
QUERY_LATEST_SAFE = """
query LatestSafe($alias:String!){
  space(alias:$alias){
    id
    name
    alias
    campaigns(input:{}){
      list{
        id
        name
        createdAt
      }
    }
  }
}
"""


def fetch_latest(alias):
    """æ‹‰å–æŸä¸ª Space çš„æœ€æ–°ä¸€ä¸ªæ´»åŠ¨ï¼ˆlist ç¬¬ä¸€ä¸ªï¼‰"""
    try:
        r = requests.post(
            OPENAPI_URL,
            json={"query": QUERY_LATEST_SAFE, "variables": {"alias": alias}},
            timeout=15
        )
        data = r.json()
        if "errors" in data:
            print("[OpenAPI é”™è¯¯]", alias, data["errors"])
            return None

        space = data.get("data", {}).get("space")
        if not space:
            return None

        lst = space.get("campaigns", {}).get("list", [])
        latest = lst[0] if lst else None
        return {"space": space, "latest": latest}
    except Exception as e:
        print("[è¯·æ±‚å¤±è´¥]", alias, e)
        return None


def build_campaign_url(alias, latest):
    """
    âœ… è¿™é‡Œæ˜¯å…³é”®ï¼šç»Ÿä¸€ç”Ÿæˆæ­£ç¡®é“¾æ¥
    æ­£ç¡®æ ¼å¼ï¼š https://app.galxe.com/quest/{alias}/{campaign_id}
    """
    if not alias or not latest:
        return None

    def gx(obj, key):
        if isinstance(obj, dict):
            return obj.get(key)
        return getattr(obj, key, None)

    cid = None
    for k in ("id", "campaignId", "campaignID", "hashId", "slug"):
        v = gx(latest, k)
        if v:
            cid = v
            break

    if not cid:
        return None

    return "https://app.galxe.com/quest/{}/{}".format(alias, cid)


# =============== ç›‘æ§ä¸»å¾ªç¯ ===============

monitor_state = {"last_loop": "", "projects": []}


def monitor_loop():
    global monitor_state
    while True:
        cfg = load_config()
        out = []

        for p in cfg.get("projects", []):
            alias = p.get("alias")
            name = p.get("name", alias)
            cat = p.get("category", "custom")

            info = fetch_latest(alias)
            latest = info["latest"] if info else None
            url = build_campaign_url(alias, latest)

            out.append(
                {
                    "name": name,
                    "alias": alias,
                    "category": cat,
                    "latest": latest,
                    "url": url
                }
            )

        monitor_state["last_loop"] = datetime.utcnow().isoformat() + "Z"
        monitor_state["projects"] = out

        write_state(monitor_state)
        time.sleep(20)  # æ¯ 20 ç§’åˆ·æ–°ä¸€æ¬¡


# =============== Web UI ===============

app = Flask(__name__)


def card_html(p):
    latest = p.get("latest")
    url = p.get("url") or "#"
    cat = p.get("category", "custom")
    tag = "ğŸ”¥ Trending" if cat == "trending" else "â­ Custom"

    if latest:
        title = latest.get("name") or "(æ— æ ‡é¢˜æ´»åŠ¨)"
        created = latest.get("createdAt") or ""
        return """
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">{name}</div>
              <div class="card-sub">@{alias} Â· {tag}</div>
            </div>
            <div class="pill pill-active">æœ‰æœ€æ–°æ´»åŠ¨</div>
          </div>
          <div class="card-body">
            <div class="activity-title">
              <span>æœ€æ–°æ´»åŠ¨ï¼š</span>
              <a href="{url}" target="_blank">{title}</a>
            </div>
            <div class="activity-meta">createdAt: {created}</div>
          </div>
        </div>
        """.format(
            name=p["name"],
            alias=p["alias"],
            tag=tag,
            url=url,
            title=title,
            created=created
        )
    else:
        return """
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">{name}</div>
              <div class="card-sub">@{alias} Â· {tag}</div>
            </div>
            <div class="pill pill-empty">æš‚æ— æ´»åŠ¨</div>
          </div>
          <div class="card-body">
            <div class="activity-title">å½“å‰æ²¡æœ‰å¯è§æ´»åŠ¨æˆ–æ‹‰å–å¤±è´¥ã€‚</div>
          </div>
        </div>
        """.format(
            name=p["name"],
            alias=p["alias"],
            tag=tag
        )


@app.route("/")
def index():
    cfg = load_config()
    pwd = request.args.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    q = (request.args.get("q") or "").lower()
    cat = (request.args.get("cat") or "all").lower()

    projs = monitor_state.get("projects", [])

    if q:
        projs = [
            p for p in projs
            if q in p.get("name", "").lower()
            or q in p.get("alias", "").lower()
        ]

    if cat in ("custom", "trending"):
        projs = [p for p in projs if p.get("category") == cat]

    cards = "".join(card_html(p) for p in projs)
    last = monitor_state.get("last_loop", "")

    active_all = "active" if cat == "all" else ""
    active_custom = "active" if cat == "custom" else ""
    active_trending = "active" if cat == "trending" else ""

    html = """
    <html>
    <head>
      <meta charset="utf-8" />
      <title>Galxe Monitor æ§åˆ¶å°</title>
      <style>
        body {{
          margin: 0;
          padding: 0;
          background: #020617;
          color: #e5e7eb;
          font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
        }}
        .container {{
          max-width: 1100px;
          margin: 0 auto;
          padding: 20px 16px 40px;
        }}
        h1 {{
          margin: 0 0 4px;
          font-size: 26px;
        }}
        .subtitle {{
          font-size: 13px;
          color: #9ca3af;
          margin-bottom: 18px;
        }}
        .top-bar {{
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          align-items: center;
          margin-bottom: 16px;
        }}
        .pill-info {{
          border-radius: 999px;
          padding: 3px 10px;
          font-size: 12px;
          border: 1px solid #1f2937;
          background:#020617;
          color:#9ca3af;
        }}
        .pill-info strong {{
          color:#e5e7eb;
        }}
        .search-box input {{
          background: #020617;
          border-radius: 999px;
          border: 1px solid #1f2937;
          padding: 6px 12px;
          color: #e5e7eb;
          outline: none;
          min-width: 180px;
        }}
        .search-box button {{
          margin-left: 6px;
          border-radius: 999px;
          border: 1px solid #374151;
          background: #111827;
          color: #e5e7eb;
          padding: 6px 12px;
          cursor: pointer;
        }}
        .filters a {{
          font-size: 13px;
          padding: 4px 10px;
          border-radius: 999px;
          border: 1px solid #1f2937;
          color: #9ca3af;
          text-decoration: none;
          margin-right: 6px;
        }}
        .filters a.active {{
          background: #2563eb;
          border-color: #2563eb;
          color: #e5e7eb;
        }}
        .actions a {{
          font-size: 12px;
          padding: 5px 10px;
          border-radius: 999px;
          border: 1px solid #4b5563;
          color: #e5e7eb;
          text-decoration: none;
        }}
        .actions a.primary {{
          background:#10b981;
          border-color:#10b981;
          color:#022c22;
          font-weight:600;
        }}
        .grid {{
          display: grid;
          grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
          gap: 14px;
          margin-top: 10px;
        }}
        .card {{
          background: radial-gradient(circle at top left,#1f2937 0,#020617 45%);
          border-radius: 14px;
          border: 1px solid #111827;
          padding: 12px 14px 12px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.45);
        }}
        .card-header {{
          display:flex;
          justify-content:space-between;
          align-items:center;
          margin-bottom:8px;
        }}
        .card-title {{
          font-size:15px;
          font-weight:600;
        }}
        .card-sub {{
          font-size:11px;
          color:#9ca3af;
          margin-top:2px;
        }}
        .pill {{
          border-radius:999px;
          padding:3px 8px;
          font-size:11px;
          border:1px solid #22c55e;
        }}
        .pill-active {{
          background:#16a34a33;
          border-color:#22c55e;
          color:#bbf7d0;
        }}
        .pill-empty {{
          background:#33415555;
          border-color:#64748b;
          color:#e5e7eb;
        }}
        .activity-title {{
          font-size:13px;
          margin-bottom:4px;
        }}
        .activity-title a {{
          color:#60a5fa;
          text-decoration:none;
        }}
        .activity-title a:hover {{
          text-decoration:underline;
        }}
        .activity-meta {{
          font-size:11px;
          color:#9ca3af;
        }}
        @media (max-width:640px) {{
          .top-bar {{
            flex-direction:column;
            align-items:flex-start;
          }}
        }}
      </style>
    </head>
    <body>
      <div class="container">
        <h1>Galxe Monitor æ§åˆ¶å°</h1>
        <div class="subtitle">
          æ¨¡å¼ï¼šå…¬å¼€ APIï¼ˆä¸ä¾èµ– Space Owner æƒé™ï¼‰ Â· æœ€ååˆ·æ–°ï¼š{last}
        </div>

        <div class="top-bar">
          <div class="pill-info">ç™»å½•å¯†ç ï¼š<strong>{pwd}</strong></div>

          <form class="search-box" method="GET" action="/">
            <input type="hidden" name="pwd" value="{pwd}">
            <input type="text" name="q" placeholder="æœç´¢ Space åç§°æˆ– aliasâ€¦" value="{q}">
            <button type="submit">æœç´¢</button>
          </form>

          <div class="filters">
            <a href="/?pwd={pwd}&cat=all" class="{active_all}">å…¨éƒ¨</a>
            <a href="/?pwd={pwd}&cat=custom" class="{active_custom}">è‡ªå®šä¹‰</a>
            <a href="/?pwd={pwd}&cat=trending" class="{active_trending}">çƒ­åº¦Top</a>
          </div>

          <div class="actions">
            <a href="/manage?pwd={pwd}" class="primary">é¡¹ç›®ç®¡ç†</a>
          </div>
        </div>

        <div class="grid">
          {cards}
        </div>
      </div>
    </body>
    </html>
    """.format(
        last=last,
        pwd=cfg["webui_password"],
        q=q,
        active_all=active_all,
        active_custom=active_custom,
        active_trending=active_trending,
        cards=cards
        or '<div style="color:#9ca3af;font-size:13px;">å½“å‰æ²¡æœ‰ä»»ä½•é¡¹ç›®ã€‚</div>',
    )
    return html


@app.route("/manage")
def manage():
    cfg = load_config()
    pwd = request.args.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    rows = ""
    for i, p in enumerate(cfg.get("projects", [])):
        rows += "<tr><td>{}</td><td>{}</td><td>{}</td><td>{}</td></tr>".format(
            i, p.get("name"), p.get("alias"), p.get("category", "custom")
        )

    html = """
    <html><head><meta charset="utf-8"><title>ç®¡ç†é¡¹ç›®</title></head>
    <body>
      <h3>å½“å‰é¡¹ç›®</h3>
      <table border="1" cellspacing="0" cellpadding="4">
        <tr><th>ç´¢å¼•</th><th>åç§°</th><th>Alias</th><th>åˆ†ç±»</th></tr>
        {rows}
      </table>

      <h4>æ·»åŠ é¡¹ç›®</h4>
      <form method="GET" action="/add">
        <input type="hidden" name="pwd" value="{pwd}">
        åç§°: <input name="name">
        Alias: <input name="alias">
        åˆ†ç±»(custom/trending): <input name="category" value="custom">
        <button type="submit">æ·»åŠ </button>
      </form>

      <h4>åˆ é™¤é¡¹ç›®</h4>
      <form method="GET" action="/delete">
        <input type="hidden" name="pwd" value="{pwd}">
        ç´¢å¼•: <input name="idx">
        <button type="submit">åˆ é™¤</button>
      </form>

      <p><a href="/?pwd={pwd}">è¿”å›ç›‘æ§é¦–é¡µ</a></p>
    </body></html>
    """.format(
        rows=rows or "<tr><td colspan='4'>æš‚æ— é¡¹ç›®</td></tr>",
        pwd=cfg["webui_password"],
    )
    return html


@app.route("/add")
def add():
    cfg = load_config()
    pwd = request.args.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    name = (request.args.get("name") or "").strip()
    alias = (request.args.get("alias") or "").strip()
    category = (request.args.get("category") or "custom").strip() or "custom"

    if not name or not alias:
        return "ç¼ºå°‘ name æˆ– alias"

    cfg.setdefault("projects", []).append(
        {"name": name, "alias": alias, "category": category}
    )
    save_config(cfg)
    return "æ·»åŠ æˆåŠŸï¼š{} ({}) [{}] Â· <a href='/?pwd={}'>è¿”å›é¦–é¡µ</a>".format(
        name, alias, category, cfg["webui_password"]
    )


@app.route("/delete")
def delete():
    cfg = load_config()
    pwd = request.args.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    idx = request.args.get("idx") or ""
    try:
        i = int(idx)
    except Exception:
        return "idx å¿…é¡»æ˜¯æ•´æ•°"

    lst = cfg.get("projects", [])
    if 0 <= i < len(lst):
        removed = lst.pop(i)
        save_config(cfg)
        return "å·²åˆ é™¤ï¼š{} ({}) Â· <a href='/?pwd={}'>è¿”å›é¦–é¡µ</a>".format(
            removed.get("name"), removed.get("alias"), cfg["webui_password"]
        )
    else:
        return "ç´¢å¼•è¶…å‡ºèŒƒå›´"


@app.route("/raw")
def raw():
    cfg = load_config()
    pwd = request.args.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    return app.response_class(
        response=json.dumps(monitor_state, indent=2, ensure_ascii=False),
        mimetype="application/json",
    )


def start_monitor():
    t = threading.Thread(target=monitor_loop, daemon=True)
    t.start()


if __name__ == "__main__":
    os.makedirs(ROOT, exist_ok=True)
    ensure_config()
    cfg = load_config()

    print("=== Galxe Monitor V3.7ï¼ˆçº¯å‡€ç‰ˆï¼‰ ===")
    print("Web UI å¯†ç :", cfg["webui_password"])
    print("è®¿é—®: http://æœåŠ¡å™¨IP:{}/?pwd={}".format(cfg["webui_port"], cfg["webui_password"]))

    start_monitor()
    app.run(host="0.0.0.0", port=cfg["webui_port"], debug=False)
