#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# NTX Quest Radar V4.0
# - ä½¿ç”¨ Galxe Open API
# - å¡ç‰‡åªæ˜¾ç¤ºï¼šå¼€å§‹æ—¶é—´ / ç»“æŸæ—¶é—´ / æ´»åŠ¨çŠ¶æ€ï¼ˆæœªå¼€å§‹ / è¿›è¡Œä¸­ / å·²ç»“æŸï¼‰
# - åˆ é™¤â€œåˆ›å»ºæ—¶é—´â€æ˜¾ç¤ºï¼Œé¿å…æ— æ„ä¹‰çš„ "-"
# - é¡¶éƒ¨å¯¼èˆª + æ›´ç°ä»£çš„å¡ç‰‡å¸ƒå±€
# - æ”¯æŒé¡¹ç›®ç®¡ç†ï¼ˆå•ä¸ªæ·»åŠ  / æ‰¹é‡å¯¼å…¥ / åˆ é™¤ï¼‰
# - æ”¯æŒ Telegram / Discord æ¨é€ + æµ‹è¯•é€šçŸ¥

import json
import os
import threading
import time
from datetime import datetime, timezone, timedelta

import requests
from flask import Flask, request

ROOT = "/opt/GalxeMonitor"
CONFIG_PATH = os.path.join(ROOT, "config.json")
STATE_PATH = os.path.join(ROOT, "monitor_state.json")
OPENAPI_URL = "https://graphigo.prd.galaxy.eco/query"

last_notified = {}  # alias -> last campaign id


# =============== é…ç½®ç®¡ç† ===============

def ensure_config():
    if not os.path.exists(CONFIG_PATH):
        cfg = {
            "webui_port": 5001,
            "webui_password": "admin",
            "notify_method": "none",          # none / telegram / discord / both
            "telegram_bot_token": "",
            "telegram_chat_id": "",
            "discord_webhook_url": "",
            "projects": [
                {"name": "BNB Chain", "alias": "bnbchain", "category": "trending"},
                {"name": "Galxe Official", "alias": "Galxe", "category": "trending"},
                {"name": "OKX Web3", "alias": "okxweb3", "category": "trending"},
                {"name": "Zaiffer Quest", "alias": "Zaiffer", "category": "trending"},
            ],
        }
        with open(CONFIG_PATH, "w", encoding="utf-8") as f:
            json.dump(cfg, f, indent=2, ensure_ascii=False)


def load_config():
    with open(CONFIG_PATH, "r", encoding="utf-8") as f:
        return json.load(f)


def save_config(cfg):
    with open(CONFIG_PATH, "w", encoding="utf-8") as f:
        json.dump(cfg, f, indent=2, ensure_ascii=False)


def write_state(state):
    try:
        with open(STATE_PATH, "w", encoding="utf-8") as f:
            json.dump(state, f, indent=2, ensure_ascii=False)
    except Exception as e:
        print("[å†™å…¥ monitor_state.json å¤±è´¥]:", e)


# =============== OpenAPI ===============

QUERY_LATEST_SAFE = """
query LatestSafe($alias:String!){
  space(alias:$alias){
    id
    name
    alias
    campaigns(input:{}){
      list{
        id
        name
        createdAt
        startTime
        endTime
      }
    }
  }
}
"""


def fetch_latest(alias):
    try:
        r = requests.post(
            OPENAPI_URL,
            json={"query": QUERY_LATEST_SAFE, "variables": {"alias": alias}},
            timeout=15,
        )
        data = r.json()
        if "errors" in data:
            print("[OpenAPI é”™è¯¯]", alias, data["errors"])
            return None

        space = data.get("data", {}).get("space")
        if not space:
            return None

        lst = space.get("campaigns", {}).get("list", [])
        latest = lst[0] if lst else None
        return {"space": space, "latest": latest}
    except Exception as e:
        print("[è¯·æ±‚å¤±è´¥]", alias, e)
        return None


def _extract_campaign_id(latest):
    if not latest:
        return None

    def gx(obj, key):
        if isinstance(obj, dict):
            return obj.get(key)
        return getattr(obj, key, None)

    for k in ("id", "campaignId", "campaignID", "hashId", "slug"):
        v = gx(latest, k)
        if v:
            return v
    return None


def build_campaign_url(alias, latest):
    if not alias or not latest:
        return None
    cid = _extract_campaign_id(latest)
    if not cid:
        return None
    # ä½¿ç”¨ /quest/alias/campaignId æ ¼å¼ï¼Œè§„é¿ 404
    return "https://app.galxe.com/quest/{}/{}".format(alias, cid)


# =============== æ—¶é—´ä¸çŠ¶æ€å¤„ç† ===============

def _fmt_time(t):
    """æŠŠæ—¶é—´æˆ³ / ISO å­—ç¬¦ä¸²è½¬æˆ åŒ—äº¬æ—¶é—´ï¼Œå¯è¯»æ ¼å¼ã€‚"""
    if not t:
        return "-"

    CST = timezone(timedelta(hours=8))

    # ç›´æ¥æ˜¯ datetime
    if isinstance(t, datetime):
        return t.astimezone(CST).strftime("%Y-%m-%d %H:%M:%S")

    # æ•°å­—ï¼ˆæ—¶é—´æˆ³ï¼‰
    try:
        if isinstance(t, (int, float)):
            ts = float(t)
        elif isinstance(t, str):
            s = t.strip()
            if s.isdigit():
                ts = float(s)
            else:
                # å°è¯•å½“ ISO æ ¼å¼è§£æ
                try:
                    dt = datetime.fromisoformat(s.replace("Z", "+00:00"))
                    return dt.astimezone(CST).strftime("%Y-%m-%d %H:%M:%S")
                except Exception:
                    return s
        else:
            return str(t)

        if ts > 1e12:  # æ¯«ç§’çº§
            ts = ts / 1000.0
        dt = datetime.fromtimestamp(ts, tz=CST)
        return dt.strftime("%Y-%m-%d %H:%M:%S")
    except Exception:
        return str(t)


def _parse_ts(t):
    """æŠŠå„ç§æ—¶é—´å½¢å¼ç»Ÿä¸€æˆ UTC datetimeï¼Œå¤±è´¥è¿”å› Noneã€‚"""
    if not t:
        return None
    if isinstance(t, datetime):
        if t.tzinfo is None:
            return t.replace(tzinfo=timezone.utc)
        return t.astimezone(timezone.utc)
    try:
        if isinstance(t, (int, float)):
            ts = float(t)
        elif isinstance(t, str):
            s = t.strip()
            if s.isdigit():
                ts = float(s)
            else:
                # ISO
                try:
                    dt = datetime.fromisoformat(s.replace("Z", "+00:00"))
                    if dt.tzinfo is None:
                        dt = dt.replace(tzinfo=timezone.utc)
                    return dt.astimezone(timezone.utc)
                except Exception:
                    return None
        else:
            return None

        if ts > 1e12:
            ts = ts / 1000.0
        return datetime.fromtimestamp(ts, tz=timezone.utc)
    except Exception:
        return None


def _build_status(latest):
    """æ ¹æ® startTime / endTime è®¡ç®—çŠ¶æ€ï¼šæœªå¼€å§‹ / è¿›è¡Œä¸­ / å·²ç»“æŸã€‚"""
    if not latest:
        return "æœªçŸ¥"

    now = datetime.utcnow().replace(tzinfo=timezone.utc)
    start = _parse_ts(latest.get("startTime"))
    end = _parse_ts(latest.get("endTime"))

    if start and now < start:
        return "â³ æœªå¼€å§‹"
    if end and now > end:
        return "âš ï¸ å·²ç»“æŸ"
    if start and (not end or start <= now <= end):
        return "âœ… è¿›è¡Œä¸­"
    return "æœªçŸ¥"


# =============== æ¨é€é€šçŸ¥ ===============

def _build_notify_text(project_name, alias, latest, url):
    title = (latest or {}).get("name") or "(æ— æ ‡é¢˜æ´»åŠ¨)"
    start = _fmt_time(latest.get("startTime")) if latest else "-"
    end = _fmt_time(latest.get("endTime")) if latest else "-"
    status = _build_status(latest)

    lines = [
        "ã€NTX Quest Radarã€‘å‘ç°æ–°æ´»åŠ¨",
        "é¡¹ç›®ï¼š{} (@{})".format(project_name, alias),
        "æ´»åŠ¨ï¼š{}".format(title),
        "çŠ¶æ€ï¼š{}".format(status),
        "å¼€å§‹æ—¶é—´ï¼š{}".format(start),
        "ç»“æŸæ—¶é—´ï¼š{}".format(end),
        "é“¾æ¥ï¼š{}".format(url or "-"),
    ]
    return "\n".join(lines)


def send_telegram(cfg, text):
    token = cfg.get("telegram_bot_token") or ""
    chat_id = cfg.get("telegram_chat_id") or ""
    if not token or not chat_id:
        return
    try:
        url = "https://api.telegram.org/bot{}/sendMessage".format(token)
        requests.post(url, data={"chat_id": chat_id, "text": text}, timeout=10)
    except Exception as e:
        print("[Telegram æ¨é€å¤±è´¥]", e)


def send_discord(cfg, text):
    webhook = cfg.get("discord_webhook_url") or ""
    if not webhook:
        return
    try:
        requests.post(webhook, json={"content": text}, timeout=10)
    except Exception as e:
        print("[Discord æ¨é€å¤±è´¥]", e)


def send_notifications(cfg, project_name, alias, latest, url):
    method = (cfg.get("notify_method") or "none").lower()
    if method == "none":
        return
    text = _build_notify_text(project_name, alias, latest, url)
    if method in ("telegram", "both"):
        send_telegram(cfg, text)
    if method in ("discord", "both"):
        send_discord(cfg, text)


# =============== ç›‘æ§ä¸»å¾ªç¯ ===============

monitor_state = {"last_loop": "", "projects": []}


def monitor_loop():
    global monitor_state, last_notified
    first_loop = True

    while True:
        cfg = load_config()
        out = []

        for p in cfg.get("projects", []):
            alias = p.get("alias")
            name = p.get("name", alias)
            cat = p.get("category", "custom")

            info = fetch_latest(alias)
            latest = info["latest"] if info else None
            url = build_campaign_url(alias, latest)

            out.append(
                {
                    "name": name,
                    "alias": alias,
                    "category": cat,
                    "latest": latest,
                    "url": url,
                }
            )

            cid = _extract_campaign_id(latest)
            if not first_loop and cid and latest:
                prev = last_notified.get(alias)
                if prev != cid:
                    send_notifications(cfg, name, alias, latest, url)
                    last_notified[alias] = cid

        monitor_state["last_loop"] = datetime.utcnow().isoformat() + "Z"
        monitor_state["projects"] = out
        write_state(monitor_state)

        first_loop = False
        time.sleep(20)


# =============== Web UI ===============

app = Flask(__name__)


def card_html(p):
    latest = p.get("latest")
    url = p.get("url") or "#"
    cat = p.get("category", "custom")
    tag = "ğŸ”¥ Trending" if cat == "trending" else "â­ Custom"

    if latest:
        title = latest.get("name") or "(æ— æ ‡é¢˜æ´»åŠ¨)"
        start = _fmt_time(latest.get("startTime"))
        end = _fmt_time(latest.get("endTime"))
        status = _build_status(latest)

        return """
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">{name}</div>
              <div class="card-sub">@{alias} Â· {tag}</div>
            </div>
            <div class="pill pill-active">{status}</div>
          </div>
          <div class="card-body">
            <div class="activity-title">
              <span>æœ€æ–°æ´»åŠ¨ï¼š</span>
              <a href="{url}" target="_blank">{title}</a>
            </div>
            <div class="activity-meta">
              <div>å¼€å§‹æ—¶é—´ï¼š{start}</div>
              <div>ç»“æŸæ—¶é—´ï¼š{end}</div>
            </div>
          </div>
        </div>
        """.format(
            name=p["name"],
            alias=p["alias"],
            tag=tag,
            url=url,
            title=title,
            start=start,
            end=end,
            status=status,
        )
    else:
        return """
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">{name}</div>
              <div class="card-sub">@{alias} Â· {tag}</div>
            </div>
            <div class="pill pill-empty">æš‚æ— æ´»åŠ¨</div>
          </div>
          <div class="card-body">
            <div class="activity-title">å½“å‰æ²¡æœ‰å¯è§æ´»åŠ¨æˆ–æ‹‰å–å¤±è´¥ã€‚</div>
          </div>
        </div>
        """.format(
            name=p["name"],
            alias=p["alias"],
            tag=tag,
        )


@app.route("/")
def index():
    cfg = load_config()
    pwd = request.args.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    q = (request.args.get("q") or "").lower()
    cat = (request.args.get("cat") or "all").lower()

    projs = monitor_state.get("projects", [])

    if q:
        filtered = []
        for p in projs:
            if q in (p.get("name", "").lower()) or q in (p.get("alias", "").lower()):
                filtered.append(p)
        projs = filtered

    if cat in ("custom", "trending"):
        projs = [p for p in projs if p.get("category") == cat]

    cards = "".join(card_html(p) for p in projs)
    last = monitor_state.get("last_loop", "")

    active_all = "active" if cat == "all" else ""
    active_custom = "active" if cat == "custom" else ""
    active_trending = "active" if cat == "trending" else ""

    html = """
    <html>
    <head>
      <meta charset="utf-8" />
      <title>NTX Quest Radar æ§åˆ¶å°</title>
      <style>
        body {{
          margin: 0;
          padding: 0;
          background: #020617;
          color: #e5e7eb;
          font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
        }}
        .shell {{
          min-height: 100vh;
          background: radial-gradient(circle at top left,#0b1120 0,#020617 45%);
        }}
        .container {{
          max-width: 1100px;
          margin: 0 auto;
          padding: 20px 16px 40px;
        }}
        .top-nav {{
          display:flex;
          justify-content:space-between;
          align-items:center;
          margin-bottom:12px;
        }}
        .brand {{
          font-size:20px;
          font-weight:600;
        }}
        .brand span {{
          font-size:11px;
          color:#9ca3af;
          margin-left:6px;
        }}
        .nav-links a {{
          font-size:13px;
          margin-left:10px;
          color:#9ca3af;
          text-decoration:none;
          padding:4px 10px;
          border-radius:999px;
          border:1px solid transparent;
        }}
        .nav-links a.active {{
          color:#e5e7eb;
          border-color:#1d4ed8;
          background:#1d4ed833;
        }}
        .subtitle {{
          font-size:13px;
          color: #9ca3af;
          margin-bottom: 14px;
        }}
        .top-bar {{
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          align-items: center;
          margin-bottom: 16px;
        }}
        .pill-info {{
          border-radius: 999px;
          padding: 4px 12px;
          font-size: 12px;
          border: 1px solid #1f2937;
          background:#020617;
          color:#9ca3af;
        }}
        .pill-info strong {{
          color:#e5e7eb;
        }}
        .search-box input {{
          background: #020617;
          border-radius: 999px;
          border: 1px solid #1f2937;
          padding: 6px 12px;
          color: #e5e7eb;
          outline: none;
          min-width: 180px;
        }}
        .search-box button {{
          margin-left: 6px;
          border-radius: 999px;
          border: 1px solid #374151;
          background: #111827;
          color: #e5e7eb;
          padding: 6px 12px;
          cursor: pointer;
        }}
        .filters a {{
          font-size: 13px;
          padding: 4px 10px;
          border-radius: 999px;
          border: 1px solid #1f2937;
          color: #9ca3af;
          text-decoration: none;
          margin-right: 6px;
        }}
        .filters a.active {{
          background: #2563eb;
          border-color: #2563eb;
          color: #e5e7eb;
        }}
        .actions a {{
          font-size: 12px;
          padding: 5px 10px;
          border-radius: 999px;
          border: 1px solid #4b5563;
          color: #e5e7eb;
          text-decoration: none;
        }}
        .actions a.primary {{
          background:#10b981;
          border-color:#10b981;
          color:#022c22;
          font-weight:600;
        }}
        .grid {{
          display: grid;
          grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
          gap: 14px;
          margin-top: 10px;
        }}
        .card {{
          background: radial-gradient(circle at top left,#111827 0,#020617 55%);
          border-radius: 14px;
          border: 1px solid #111827;
          padding: 12px 14px 12px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.45);
        }}
        .card-header {{
          display:flex;
          justify-content:space-between;
          align-items:center;
          margin-bottom:8px;
        }}
        .card-title {{
          font-size:15px;
          font-weight:600;
        }}
        .card-sub {{
          font-size:11px;
          color:#9ca3af;
          margin-top:2px;
        }}
        .pill {{
          border-radius:999px;
          padding:3px 8px;
          font-size:11px;
          border:1px solid #22c55e;
        }}
        .pill-active {{
          background:#16a34a33;
          border-color:#22c55e;
          color:#bbf7d0;
        }}
        .pill-empty {{
          background:#33415555;
          border-color:#64748b;
          color:#e5e7eb;
        }}
        .activity-title {{
          font-size:13px;
          margin-bottom:4px;
        }}
        .activity-title a {{
          color:#60a5fa;
          text-decoration:none;
        }}
        .activity-title a:hover {{
          text-decoration:underline;
        }}
        .activity-meta {{
          font-size:11px;
          color:#9ca3af;
        }}
        @media (max-width:640px) {{
          .top-bar {{
            flex-direction:column;
            align-items:flex-start;
          }}
          .top-nav {{
            flex-direction:column;
            align-items:flex-start;
            gap:4px;
          }}
        }}
      </style>
    </head>
    <body>
      <div class="shell">
        <div class="container">

          <div class="top-nav">
            <div class="brand">
              NTX Quest Radar
              <span>OpenAPI Â· V4.0 Â· TEST</span>
            </div>
            <div class="nav-links">
              <a href="/?pwd={pwd}" class="active">æ´»åŠ¨ç›‘æ§</a>
              <a href="/manage?pwd={pwd}">é¡¹ç›®ç®¡ç†</a>
            </div>
          </div>

          <div class="subtitle">
            æ¨¡å¼ï¼šå…¬å¼€ APIï¼ˆä¸ä¾èµ– Space Owner æƒé™ï¼‰ Â· é¢å‘ NTX ç”¨æˆ·å¼€æ”¾é¢„è§ˆ Â· æœ€ååˆ·æ–°ï¼š{last}
          </div>

          <div class="top-bar">
            <div class="pill-info">ç™»å½•å¯†ç ï¼š<strong>{pwd}</strong></div>

            <form class="search-box" method="GET" action="/">
              <input type="hidden" name="pwd" value="{pwd}">
              <input type="text" name="q" placeholder="æœç´¢ Space åç§°æˆ– aliasâ€¦" value="{q}">
              <button type="submit">æœç´¢</button>
            </form>

            <div class="filters">
              <a href="/?pwd={pwd}&cat=all" class="{active_all}">å…¨éƒ¨</a>
              <a href="/?pwd={pwd}&cat=custom" class="{active_custom}">è‡ªå®šä¹‰</a>
              <a href="/?pwd={pwd}&cat=trending" class="{active_trending}">çƒ­åº¦Top</a>
            </div>

            <div class="actions">
              <a href="/manage?pwd={pwd}" class="primary">é¡¹ç›®ç®¡ç†</a>
            </div>
          </div>

          <div class="grid">
            {cards}
          </div>

        </div>
      </div>
    </body>
    </html>
    """.format(
        last=last,
        pwd=cfg["webui_password"],
        q=q,
        active_all=active_all,
        active_custom=active_custom,
        active_trending=active_trending,
        cards=cards
        or '<div style="color:#9ca3af;font-size:13px;">å½“å‰æ²¡æœ‰ä»»ä½•é¡¹ç›®ã€‚</div>',
    )
    return html


@app.route("/manage")
def manage():
    cfg = load_config()
    pwd = request.args.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    rows = ""
    for i, p in enumerate(cfg.get("projects", [])):
        name = p.get("name", "")
        alias = p.get("alias", "")
        cat = p.get("category", "custom")
        rows += "<tr><td>{}</td><td>{}</td><td>{}</td><td>{}</td></tr>".format(
            i, name, alias, cat
        )

    if not rows:
        rows = '<tr><td colspan="4">æš‚æ— é¡¹ç›®ï¼Œè¯·åœ¨ä¸Šæ–¹æ“ä½œé¢æ¿ä¸­æ·»åŠ ã€‚</td></tr>'

    method = (cfg.get("notify_method") or "none").lower()
    tg_bot = cfg.get("telegram_bot_token", "")
    tg_chat = cfg.get("telegram_chat_id", "")
    discord = cfg.get("discord_webhook_url", "")

    sel_none = "selected" if method == "none" else ""
    sel_tg = "selected" if method == "telegram" else ""
    sel_dc = "selected" if method == "discord" else ""
    sel_both = "selected" if method == "both" else ""

    html = """
    <html>
    <head>
      <meta charset="utf-8" />
      <title>NTX Quest Radar Â· é¡¹ç›®ç®¡ç†</title>
      <style>
        body {{
          margin: 0;
          padding: 0;
          background: #020617;
          color: #e5e7eb;
          font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;
        }}
        .shell {{
          min-height:100vh;
          background: radial-gradient(circle at top left,#0b1120 0,#020617 45%);
        }}
        .container {{
          max-width: 960px;
          margin: 0 auto;
          padding: 20px 16px 40px;
        }}
        .top-nav {{
          display:flex;
          justify-content:space-between;
          align-items:center;
          margin-bottom:12px;
        }}
        .brand {{
          font-size:20px;
          font-weight:600;
        }}
        .brand span {{
          font-size:11px;
          color:#9ca3af;
          margin-left:6px;
        }}
        .nav-links a {{
          font-size:13px;
          margin-left:10px;
          color:#9ca3af;
          text-decoration:none;
          padding:4px 10px;
          border-radius:999px;
          border:1px solid transparent;
        }}
        .nav-links a.active {{
          color:#e5e7eb;
          border-color:#1d4ed8;
          background:#1d4ed833;
        }}
        .subtitle {{
          font-size:13px;
          color: #9ca3af;
          margin-bottom: 14px;
        }}
        a {{ color:#60a5fa; text-decoration:none; }}
        a:hover {{ text-decoration:underline; }}
        .card {{
          background: radial-gradient(circle at top left,#111827 0,#020617 55%);
          border-radius: 14px;
          border: 1px solid #111827;
          padding: 14px 16px 16px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.45);
          margin-bottom: 14px;
        }}
        .card-header {{
          display:flex;
          justify-content:space-between;
          align-items:center;
          margin-bottom:10px;
        }}
        .card-title {{
          font-size:15px;
          font-weight:600;
        }}
        .pill-back {{
          border-radius:999px;
          padding:4px 10px;
          font-size:12px;
          border:1px solid #374151;
          background:#020617;
        }}
        table {{
          width: 100%;
          border-collapse: collapse;
          font-size: 13px;
        }}
        th, td {{
          border-bottom: 1px solid #1f2937;
          padding: 6px 8px;
          text-align: left;
          white-space: nowrap;
        }}
        th {{
          font-weight:500;
          color:#9ca3af;
          background:#020617;
        }}
        tr:hover td {{
          background:#020617;
        }}
        .form-row {{
          display:flex;
          flex-wrap:wrap;
          gap:8px;
          align-items:center;
          margin-top:8px;
        }}
        .form-row label {{
          font-size:12px;
          color:#9ca3af;
        }}
        .form-row input, .form-row textarea {{
          background:#020617;
          border-radius:8px;
          border:1px solid #1f2937;
          padding:6px 10px;
          color:#e5e7eb;
          font-size:12px;
        }}
        .form-row textarea {{
          width:100%;
          min-height:70px;
          font-family:monospace;
        }}
        .form-row select {{
          background:#020617;
          border-radius:8px;
          border:1px solid #1f2937;
          padding:6px 10px;
          color:#e5e7eb;
          font-size:12px;
        }}
        .btn {{
          border-radius:999px;
          border:1px solid #4b5563;
          background:#111827;
          color:#e5e7eb;
          padding:6px 12px;
          font-size:12px;
          cursor:pointer;
        }}
        .btn-primary {{
          background:#10b981;
          border-color:#10b981;
          color:#022c22;
          font-weight:600;
        }}
        .hint {{
          font-size:11px;
          color:#9ca3af;
          margin-top:4px;
        }}
        @media (max-width:640px) {{
          .form-row {{
            flex-direction:column;
            align-items:flex-start;
          }}
          .top-nav {{
            flex-direction:column;
            align-items:flex-start;
            gap:4px;
          }}
        }}
      </style>
    </head>
    <body>
      <div class="shell">
        <div class="container">

          <div class="top-nav">
            <div class="brand">
              NTX Quest Radar
              <span>é¡¹ç›®ç®¡ç†</span>
            </div>
            <div class="nav-links">
              <a href="/?pwd={pwd}">æ´»åŠ¨ç›‘æ§</a>
              <a href="/manage?pwd={pwd}" class="active">é¡¹ç›®ç®¡ç†</a>
            </div>
          </div>

        <div class="subtitle">
          åœ¨è¿™é‡Œå¿«é€Ÿå¢åˆ ä½ è¦ç›‘æ§çš„ Galxe Spaceï¼Œå¹¶é…ç½®é€šçŸ¥æ–¹å¼ã€‚
        </div>

        <!-- é¡¶éƒ¨æ“ä½œé¢æ¿ -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">æ“ä½œé¢æ¿</div>
            <a class="pill-back" href="/?pwd={pwd}">â† è¿”å›ç›‘æ§é¦–é¡µ</a>
          </div>

          <!-- å•ä¸ªæ·»åŠ  -->
          <form method="GET" action="/add">
            <input type="hidden" name="pwd" value="{pwd}">
            <div class="form-row">
              <label>åç§°</label>
              <input name="name" placeholder="ä¾‹å¦‚ï¼šBNB Chain">
              <label>Alias</label>
              <input name="alias" placeholder="ä¾‹å¦‚ï¼šbnbchain">
              <label>åˆ†ç±»</label>
              <input name="category" value="custom" placeholder="custom æˆ– trending">
              <button type="submit" class="btn btn-primary">æ·»åŠ å•ä¸ªé¡¹ç›®</button>
            </div>
            <div class="hint">Alias é€šå¸¸å¯ä»¥ä» Space URL ä¸­çœ‹åˆ°ï¼ˆapp.galxe.com/space/&lt;alias&gt;ï¼‰ã€‚</div>
          </form>

          <!-- æ‰¹é‡å¯¼å…¥ -->
          <form method="POST" action="/add_bulk" style="margin-top:12px;">
            <input type="hidden" name="pwd" value="{pwd}">
            <div class="form-row">
              <label>æ‰¹é‡å¯¼å…¥</label>
              <textarea name="bulk" placeholder="æ¯è¡Œä¸€ä¸ªï¼šæ”¯æŒä¸‰ç§æ ¼å¼ï¼š
1) alias
2) name,alias
3) name,alias,categoryï¼ˆå¦‚ï¼šBNB Chain,bnbchain,trendingï¼‰"></textarea>
              <button type="submit" class="btn">æ‰¹é‡å¯¼å…¥</button>
            </div>
            <div class="hint">
              ç¤ºä¾‹ï¼š<br>
              <code>bnbchain</code><br>
              <code>Arbitrum,arbitrum</code><br>
              <code>OKX Web3,okxweb3,trending</code>
            </div>
          </form>

          <!-- åˆ é™¤é¡¹ç›® -->
          <form method="GET" action="/delete" style="margin-top:12px;">
            <input type="hidden" name="pwd" value="{pwd}">
            <div class="form-row">
              <label>åˆ é™¤é¡¹ç›®ï¼ˆæŒ‰ç´¢å¼•ï¼‰</label>
              <input name="idx" placeholder="åœ¨ä¸‹æ–¹è¡¨æ ¼ä¸­æŸ¥çœ‹ç´¢å¼•ï¼Œä¾‹å¦‚ï¼š0">
              <button type="submit" class="btn">åˆ é™¤</button>
            </div>
            <div class="hint">åˆ é™¤åä¼šç«‹å³ä¿å­˜ï¼Œæ— éœ€é‡å¯ç¨‹åºã€‚</div>
          </form>

          <!-- é€šçŸ¥é…ç½® -->
          <form method="POST" action="/save_notify" style="margin-top:16px;">
            <input type="hidden" name="pwd" value="{pwd}">
            <div class="form-row">
              <label>é€šçŸ¥æ–¹å¼</label>
              <select name="notify_method">
                <option value="none" {sel_none}>noneï¼ˆä¸æ¨é€ï¼‰</option>
                <option value="telegram" {sel_tg}>telegram</option>
                <option value="discord" {sel_dc}>discord</option>
                <option value="both" {sel_both}>bothï¼ˆTG + Discordï¼‰</option>
              </select>
              <button type="submit" class="btn btn-primary">ä¿å­˜é€šçŸ¥é…ç½®</button>
              <a class="btn" href="/notify_test?pwd={pwd}">å‘é€æµ‹è¯•é€šçŸ¥</a>
            </div>
            <div class="form-row">
              <label>Telegram Bot Token</label>
              <input name="telegram_bot_token" value="{tg_bot}" placeholder="å½¢å¦‚ï¼š123456:ABC-DEF...">
              <label>Telegram Chat ID</label>
              <input name="telegram_chat_id" value="{tg_chat}" placeholder="ä½ çš„ chat id">
            </div>
            <div class="form-row">
              <label>Discord Webhook URL</label>
              <input style="flex:1;min-width:260px;" name="discord_webhook_url" value="{discord}" placeholder="https://discord.com/api/webhooks/...">
            </div>
            <div class="hint">
              è¯´æ˜ï¼šé€šçŸ¥æ–¹å¼å¯é€‰ none / telegram / discord / bothã€‚å»ºè®®å…ˆä¿å­˜é…ç½®ï¼Œç„¶åç‚¹å‡»â€œå‘é€æµ‹è¯•é€šçŸ¥â€ç¡®è®¤æ˜¯å¦èƒ½æ”¶åˆ°æ¶ˆæ¯ã€‚
            </div>
          </form>
        </div>

        <!-- å½“å‰é¡¹ç›®åˆ—è¡¨ -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">å½“å‰å·²ç›‘æ§é¡¹ç›®</div>
          </div>
          <div style="overflow-x:auto;">
            <table>
              <tr><th>ç´¢å¼•</th><th>åç§°</th><th>Alias</th><th>åˆ†ç±»</th></tr>
              {rows}
            </table>
          </div>
        </div>

      </div>
     </div>
    </body>
    </html>
    """.format(
        rows=rows,
        pwd=cfg["webui_password"],
        sel_none=sel_none,
        sel_tg=sel_tg,
        sel_dc=sel_dc,
        sel_both=sel_both,
        tg_bot=tg_bot,
        tg_chat=tg_chat,
        discord=discord,
    )
    return html


@app.route("/add")
def add():
    cfg = load_config()
    pwd = request.args.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    name = (request.args.get("name") or "").strip()
    alias = (request.args.get("alias") or "").strip()
    category = (request.args.get("category") or "custom").strip() or "custom"

    if not name or not alias:
        return "ç¼ºå°‘ name æˆ– alias"

    cfg.setdefault("projects", []).append(
        {"name": name, "alias": alias, "category": category}
    )
    save_config(cfg)
    return "æ·»åŠ æˆåŠŸï¼š{} ({}) [{}] Â· <a href='/?pwd={}'>è¿”å›é¦–é¡µ</a>".format(
        name, alias, category, cfg["webui_password"]
    )


@app.route("/add_bulk", methods=["GET", "POST"])
def add_bulk():
    cfg = load_config()
    pwd = request.values.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    text = (request.values.get("bulk") or "").strip()
    if not text:
        return "æœªæ”¶åˆ°ä»»ä½•å†…å®¹ Â· <a href='/manage?pwd={}'>è¿”å›ç®¡ç†é¡µé¢</a>".format(
            cfg["webui_password"]
        )

    lines = text.splitlines()
    added = 0

    for line in lines:
        line = line.strip()
        if not line or line.startswith("#"):
            continue
        parts = [x.strip() for x in line.split(",") if x.strip()]
        if len(parts) == 1:
            alias = parts[0]
            name = alias
            category = "custom"
        elif len(parts) == 2:
            name, alias = parts
            category = "custom"
        else:
            name, alias, category = parts[0], parts[1], parts[2] or "custom"

        cfg.setdefault("projects", []).append(
            {"name": name, "alias": alias, "category": category}
        )
        added += 1

    save_config(cfg)
    return "æ‰¹é‡æ·»åŠ å®Œæˆï¼Œå…±æ·»åŠ  {} ä¸ªé¡¹ç›®ã€‚<a href='/?pwd={}'>è¿”å›é¦–é¡µ</a>".format(
        added, cfg["webui_password"]
    )


@app.route("/delete")
def delete():
    cfg = load_config()
    pwd = request.args.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    idx = request.args.get("idx") or ""
    try:
        i = int(idx)
    except Exception:
        return "idx å¿…é¡»æ˜¯æ•´æ•°"

    lst = cfg.get("projects", [])
    if 0 <= i < len(lst):
        removed = lst.pop(i)
        save_config(cfg)
        return "å·²åˆ é™¤ï¼š{} ({}) Â· <a href='/?pwd={}'>è¿”å›é¦–é¡µ</a>".format(
            removed.get("name"), removed.get("alias"), cfg["webui_password"]
        )
    else:
        return "ç´¢å¼•è¶…å‡ºèŒƒå›´"


@app.route("/save_notify", methods=["POST"])
def save_notify():
    cfg = load_config()
    pwd = request.form.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    method = (request.form.get("notify_method") or "none").lower()
    tg_bot = request.form.get("telegram_bot_token") or ""
    tg_chat = request.form.get("telegram_chat_id") or ""
    discord = request.form.get("discord_webhook_url") or ""

    cfg["notify_method"] = method
    cfg["telegram_bot_token"] = tg_bot
    cfg["telegram_chat_id"] = tg_chat
    cfg["discord_webhook_url"] = discord
    save_config(cfg)

    return "é€šçŸ¥é…ç½®å·²ä¿å­˜ï¼ˆå½“å‰ï¼š{}ï¼‰ã€‚<a href='/manage?pwd={}'>è¿”å›ç®¡ç†é¡µé¢</a>".format(
        method, cfg["webui_password"]
    )


@app.route("/notify_test")
def notify_test():
    cfg = load_config()
    pwd = request.args.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    method = (cfg.get("notify_method") or "none").lower()
    if method == "none":
        return "å½“å‰ notify_method=noneï¼Œæœªå‘é€é€šçŸ¥ã€‚è¯·å…ˆåœ¨ç®¡ç†é¡µä¿®æ”¹ä¸º telegram/discord/bothã€‚<a href='/manage?pwd={}'>è¿”å›ç®¡ç†é¡µé¢</a>".format(
            cfg["webui_password"]
        )

    text = "ã€NTX Quest Radarã€‘è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥ï¼Œç”¨äºéªŒè¯ Telegram / Discord é…ç½®æ˜¯å¦æ­£å¸¸ã€‚"
    if method in ("telegram", "both"):
        send_telegram(cfg, text)
    if method in ("discord", "both"):
        send_discord(cfg, text)

    return "å·²æŒ‰å½“å‰é€šçŸ¥æ–¹å¼ ({}) å‘é€ä¸€æ¡æµ‹è¯•æ¶ˆæ¯ã€‚<a href='/manage?pwd={}'>è¿”å›ç®¡ç†é¡µé¢</a>".format(
        method, cfg["webui_password"]
    )


@app.route("/raw")
def raw():
    cfg = load_config()
    pwd = request.args.get("pwd", "")
    if pwd != cfg.get("webui_password"):
        return "Unauthorized", 401

    return app.response_class(
        response=json.dumps(monitor_state, indent=2, ensure_ascii=False),
        mimetype="application/json",
    )


def start_monitor():
    t = threading.Thread(target=monitor_loop, daemon=True)
    t.start()


# ===== NTX æ‰©å±•ï¼šæä¾›ç»Ÿä¸€ JSON æ¥å£ /api/raw =====
# è¯´æ˜ï¼š
# - å‰ç«¯åªè°ƒç”¨ /api/raw?pwd=admin
# - ä¸å†ä¾èµ– /?raw=1 é¿å…è¿”å› HTML çš„é—®é¢˜

try:
    from flask import request
except ImportError:
    # å¦‚æœå‰é¢å·²ç» import è¿‡ï¼Œå°±å¿½ç•¥è¿™é‡Œ
    pass


@app.route("/api/raw")
def api_raw():
    """ç»™ NTX QUEST RADAR ä½¿ç”¨çš„ JSON è¾“å‡ºã€‚"""
    pwd = (request.args.get("pwd") or "").strip()
    try:
        expected = config.data.get("webui_password", "")
    except Exception:
        expected = ""

    if expected and pwd != expected:
        return jsonify({"error": "unauthorized"}), 401

    # ç›´æ¥å¤ç”¨å…¨å±€ monitor_stateï¼ˆä¹‹å‰ç‰ˆæœ¬é‡Œå·²ç»åœ¨ä¸æ–­åˆ·æ–°ï¼‰
    try:
        global monitor_state
        if isinstance(monitor_state, dict) and monitor_state:
            return jsonify(monitor_state)
    except Exception:
        pass

    # å…œåº•ï¼šé¿å… 500ï¼Œè‡³å°‘ç»™ä¸€ä¸ªç©ºç»“æ„
    return jsonify({"projects": [], "last_loop": None})

if __name__ == "__main__":
    os.makedirs(ROOT, exist_ok=True)
    ensure_config()
    cfg = load_config()

    print("=== NTX Quest Radar V4.0ï¼ˆUI + æ—¶é—´æ˜¾ç¤ºä¼˜åŒ–ç‰ˆï¼‰ ===")
    print("Web UI å¯†ç :", cfg.get("webui_password"))
    print("è®¿é—®: http://æœåŠ¡å™¨IP:{}/?pwd={}".format(cfg["webui_port"], cfg["webui_password"]))

    start_monitor()
    app.run(host="0.0.0.0", port=cfg["webui_port"], debug=False)


# ===== NTX /api/raw ç®€åŒ–ç¨³å®šç‰ˆï¼ˆè¦†ç›–æ—§å®ç°ï¼‰ =====
from flask import request, jsonify

@app.route("/api/raw")
def api_raw_simplified():
    """
    ç¨³å®šç‰ˆç»Ÿä¸€ JSON æ¥å£ï¼š
    - æ ¡éªŒå¯†ç ï¼ˆé»˜è®¤ adminï¼Œè¯»å– config.json çš„ webui_passwordï¼‰
    - å°½é‡ä» monitor_state å–æ•°æ®ï¼Œæ²¡æœ‰å°±ä» config.data["projects"] æ„é€ ä¸€ä¸ªç®€åŒ–åˆ—è¡¨
    """
    # 1. æ ¡éªŒå¯†ç 
    pwd = request.args.get("pwd", "")
    expected_pwd = "admin"
    try:
        if "config" in globals() and hasattr(config, "data"):
            expected_pwd = config.data.get("webui_password", "admin")
    except Exception:
        pass

    if pwd != expected_pwd:
        return jsonify({"error": "unauthorized"}), 401

    # 2. ä»å†…å­˜æ€æ‹¿ç›‘æ§æ•°æ®ï¼ˆä¼˜å…ˆï¼‰
    state = None
    try:
        state = globals().get("monitor_state")
    except Exception:
        state = None

    payload = {
        "last_loop": None,
        "projects": []
    }

    if isinstance(state, dict):
        payload["last_loop"] = state.get("last_loop")
        if isinstance(state.get("projects"), list):
            payload["projects"] = state["projects"]
    else:
        # 3. å…œåº•ï¼šä» config.json é‡Œçš„ projects åˆ—è¡¨æ„é€ ä¸€ä¸ªç®€å•ç»“æ„
        try:
            cfg = globals().get("config")
            if cfg is not None and hasattr(cfg, "data"):
                projects = cfg.data.get("projects", [])
                simple_list = []
                for p in projects:
                    simple_list.append({
                        "name": p.get("name"),
                        "alias": p.get("alias"),
                        "latest": p.get("latest"),  # å¯èƒ½ä¸º None
                    })
                payload["projects"] = simple_list
        except Exception:
            pass

    return jsonify(payload)

# ===== NTX /api/raw æœ€ç»ˆç¨³å®šç‰ˆï¼ˆä»…ä» config.json æ„é€ å¹²å‡€ JSONï¼‰ =====
from flask import request, jsonify

@app.route("/api/raw")
def api_raw_ntx_final():
    """
    æœ€ç¨³å®šç‰ˆæœ¬ï¼š
    - åªä¾èµ– config.json é‡Œçš„ projects åˆ—è¡¨
    - ä¸è¯»å– monitor_stateï¼Œé¿å…å¤æ‚å¯¹è±¡å¯¼è‡´ 500
    - å­—æ®µå…¨éƒ¨ä¸ºåŸºç¡€ç±»å‹ï¼Œç¡®ä¿ jsonify ä¸€å®šæˆåŠŸ
    """
    # 1. æ ¡éªŒå¯†ç 
    pwd = request.args.get("pwd", "")
    expected_pwd = "admin"
    try:
        if "config" in globals() and hasattr(config, "data"):
            expected_pwd = config.data.get("webui_password", "admin")
    except Exception:
        pass

    if pwd != expected_pwd:
        return jsonify({"error": "unauthorized"}), 401

    projects_out = []
    try:
        cfg = globals().get("config")
        raw_projects = []
        if cfg is not None and hasattr(cfg, "data"):
            raw_projects = cfg.data.get("projects", [])

        for p in raw_projects:
            if not isinstance(p, dict):
                continue
            name = p.get("name") or ""
            alias = p.get("alias") or p.get("space_id") or ""
            latest_raw = p.get("latest") or {}

            # æŠŠ latest æ‘Šå¹³ï¼Œåªä¿ç•™åŸºç¡€å­—æ®µ
            latest = {
                "title": latest_raw.get("title") or "",
                "url": latest_raw.get("url") or "",
                # å°½é‡å…¼å®¹å‡ ç§å†™æ³•ï¼šcreatedAt / created_at ç­‰
                "createdAt": latest_raw.get("createdAt")
                              or latest_raw.get("created_at")
                              or None,
                "startTime": latest_raw.get("startTime")
                              or latest_raw.get("start_time")
                              or None,
                "endTime": latest_raw.get("endTime")
                              or latest_raw.get("end_time")
                              or None,
            }

            projects_out.append({
                "name": name,
                "alias": alias,
                "latest": latest,
            })
    except Exception:
        # å‡ºé—®é¢˜ä¹Ÿä¸è¦ 500ï¼Œç»™ä¸ªç©ºæ•°ç»„
        projects_out = []

    return jsonify({
        "last_loop": None,
        "projects": projects_out,
    })

# ===== NTX /api/raw æœ€ç»ˆç¨³å®šç‰ˆï¼ˆä»…ä» config.json æ„é€ å¹²å‡€ JSONï¼‰ =====
from flask import request, jsonify

@app.route("/api/raw")
def api_raw_ntx_final():
    """
    æœ€ç¨³å®šç‰ˆæœ¬ï¼š
    - åªä¾èµ– config.json é‡Œçš„ projects åˆ—è¡¨
    - ä¸è¯»å– monitor_stateï¼Œé¿å…å¤æ‚å¯¹è±¡å¯¼è‡´ 500
    - å­—æ®µå…¨éƒ¨ä¸ºåŸºç¡€ç±»å‹ï¼Œç¡®ä¿ jsonify ä¸€å®šæˆåŠŸ
    """
    # 1. æ ¡éªŒå¯†ç 
    pwd = request.args.get("pwd", "")
    expected_pwd = "admin"
    try:
        if "config" in globals() and hasattr(config, "data"):
            expected_pwd = config.data.get("webui_password", "admin")
    except Exception:
        pass

    if pwd != expected_pwd:
        return jsonify({"error": "unauthorized"}), 401

    projects_out = []
    try:
        cfg = globals().get("config")
        raw_projects = []
        if cfg is not None and hasattr(cfg, "data"):
            raw_projects = cfg.data.get("projects", [])

        for p in raw_projects:
            if not isinstance(p, dict):
                continue
            name = p.get("name") or ""
            alias = p.get("alias") or p.get("space_id") or ""

            latest_raw = p.get("latest") or {}
            if not isinstance(latest_raw, dict):
                latest_raw = {}

            latest = {
                "title": latest_raw.get("title") or "",
                "url": latest_raw.get("url") or "",
                "createdAt": latest_raw.get("createdAt")
                              or latest_raw.get("created_at")
                              or None,
                "startTime": latest_raw.get("startTime")
                              or latest_raw.get("start_time")
                              or None,
                "endTime": latest_raw.get("endTime")
                              or latest_raw.get("end_time")
                              or None,
            }

            projects_out.append({
                "name": name,
                "alias": alias,
                "latest": latest,
            })
    except Exception:
        # å‡ºé—®é¢˜ä¹Ÿä¸è¦ 500ï¼Œç»™ä¸ªç©ºæ•°ç»„
        projects_out = []

    return jsonify({
        "last_loop": None,
        "projects": projects_out,
    })

# ===== æç®€ç‰ˆ /api/rawï¼šåªç”¨äºè¿é€šæ€§æµ‹è¯• =====
from flask import jsonify

@app.route("/api/raw")
def api_raw_ntx_minimal():
    """
    æœ€å°å¯ç”¨ç‰ˆæœ¬ï¼š
    - ä¸è®¿é—® config
    - ä¸è®¿é—® monitor_state
    - åªè¿”å›ä¸€ä¸ªå›ºå®š JSONï¼ŒéªŒè¯è·¯ç”±æ˜¯å¦è¿˜åœ¨ 500
    """
    try:
        return jsonify({
            "last_loop": None,
            "projects": [],
            "note": "minimal api_raw, only for connectivity test"
        })
    except Exception as e:
        # ç†è®ºä¸Šè¿™é‡Œä¸ä¼šè¿›æ¥ï¼Œå¦‚æœè¿›æ¥äº†å°±æŠŠé”™è¯¯å­—ç¬¦ä¸²è¿”å›ç»™ä½ çœ‹
        return jsonify({"error": str(e)}), 500

# ===== NTX å‰ç«¯ JSON æ¥å£ Â· ä¿®æ­£ç‰ˆ =====
# è¯´æ˜ï¼š
# - å‰ç«¯åªéœ€è¦è°ƒç”¨ /api/raw?pwd=admin
# - è¿”å›æ ¼å¼ï¼š
#   {
#     "ok": true,
#     "last_refresh": "...",
#     "projects": [...]
#   }

@app.route("/api/raw")
def api_raw_v2():
    from flask import jsonify, request
    pwd = request.args.get("pwd", "")
    expect = config.data.get("webui_password", "admin")

    if pwd != expect:
        return jsonify({"ok": False, "error": "bad password"}), 401

    # monitor_state åœ¨ç›‘æ§çº¿ç¨‹é‡Œä¸æ–­æ›´æ–°ï¼›å¦‚æœæ²¡åˆå§‹åŒ–å°±ç”¨ç©ºç»“æ„å…œåº•
    global monitor_state
    state = monitor_state if isinstance(monitor_state, dict) else {}

    return jsonify({
        "ok": True,
        "last_refresh": state.get("last_loop_time"),
        "projects": state.get("projects") or [],
    })

# ===== NTX å‰ç«¯ JSON æ¥å£ Â· æ–‡ä»¶ç‰ˆ /api/rawï¼ˆè¦†ç›–ä¹‹å‰çš„ç‰ˆæœ¬ï¼‰ =====
# æ€è·¯ï¼š
# - ç›‘æ§çº¿ç¨‹å·²ç»å®šæœŸæŠŠæœ€æ–°çŠ¶æ€å†™å…¥ data/monitor_state.json
# - è¿™é‡Œä¸ä¾èµ– monitor_state å˜é‡ï¼Œç›´æ¥è¯»è¿™ä¸ªæ–‡ä»¶è¿”å›ç»™å‰ç«¯
# - å‰ç«¯åªéœ€è¦è°ƒç”¨ /api/raw?pwd=admin

@app.route("/api/raw")
def api_raw_file_based():
    import os, json
    from flask import jsonify, request

    pwd = request.args.get("pwd", "")
    # ä» config.json é‡Œçš„ webui_password è¯»å–æœŸæœ›å¯†ç ï¼Œé»˜è®¤ admin
    expect = getattr(config, "data", {}).get("webui_password", "admin")
    if pwd != expect:
        return jsonify({"ok": False, "error": "bad password"}), 401

    # ç»„è£… monitor_state.json è·¯å¾„ï¼š/opt/GalxeMonitor/data/monitor_state.json
    base_dir = os.path.dirname(os.path.abspath(__file__))
    state_path = os.path.join(base_dir, "data", "monitor_state.json")

    if not os.path.exists(state_path):
        # ç›‘æ§åˆšå¯åŠ¨ã€çŠ¶æ€æ–‡ä»¶è¿˜æ²¡å†™å‡ºæ¥æ—¶çš„å…œåº•
        return jsonify({
            "ok": True,
            "last_refresh": None,
            "projects": [],
            "note": "monitor_state.json not found yet"
        })

    try:
        with open(state_path, "r", encoding="utf-8") as f:
            state = json.load(f)
    except Exception as e:
        return jsonify({
            "ok": False,
            "error": f"load_state_failed: {e.__class__.__name__}",
        }), 500

    return jsonify({
        "ok": True,
        "last_refresh": state.get("last_loop_time"),
        "projects": state.get("projects") or [],
    })

# ===== NTX /api/raw Â· æç®€ä¿é™©ç‰ˆï¼ˆå†æ¬¡è¦†ç›–å‰é¢çš„æ‰€æœ‰ api_raw å®šä¹‰ï¼‰ =====
# ä»…ä» data/monitor_state.json è¯»çŠ¶æ€ï¼›å¦‚æœ‰ä»»ä½•å¼‚å¸¸ï¼Œä¸€å¾‹è¿”å›ç©ºæ•°æ®ä½† HTTP 200ã€‚
@app.route("/api/raw")
def api_raw_safest():
    import os, json
    from flask import jsonify, request

    # ä»¥åè¦å¯†ç å†åŠ ï¼Œè¿™é‡Œå…ˆä¸æ ¡éªŒï¼Œç¡®ä¿ä¸å† 500
    base_dir = os.path.dirname(os.path.abspath(__file__))
    state_path = os.path.join(base_dir, "data", "monitor_state.json")

    if not os.path.exists(state_path):
        return jsonify({
            "ok": True,
            "last_refresh": None,
            "projects": [],
            "note": "monitor_state.json not found yet",
        })

    try:
        with open(state_path, "r", encoding="utf-8") as f:
            state = json.load(f)
    except Exception as e:
        # å‡ºä»»ä½•é—®é¢˜éƒ½è¿”å›ç©ºåˆ—è¡¨ï¼Œä½†ä¸æŠ›å¼‚å¸¸ã€ä¸ 500
        return jsonify({
            "ok": True,
            "last_refresh": None,
            "projects": [],
            "note": f"load_state_failed: {e.__class__.__name__}",
        })

    return jsonify({
        "ok": True,
        "last_refresh": state.get("last_loop_time"),
        "projects": state.get("projects") or [],
    })

# ===== NTX /api/raw Â· æç®€ä¿é™©ç‰ˆï¼ˆå¼ºåˆ¶è¦†ç›–å‰é¢æ‰€æœ‰ api_raw å®šä¹‰ï¼‰ =====
# è¯´æ˜ï¼š
# - ä¸å†ä¾èµ– config / å¯†ç æ ¡éªŒï¼Œå…ˆä¿è¯æ°¸è¿œ 200ã€æ°¸è¿œè¿”å› JSON
# - åªä» data/monitor_state.json è¯»çŠ¶æ€ï¼›å¤±è´¥å°±è¿”å›ç©ºåˆ—è¡¨

@app.route("/api/raw")
def api_raw_safest():
    import os, json
    from flask import jsonify

    base_dir = os.path.dirname(os.path.abspath(__file__))
    state_path = os.path.join(base_dir, "data", "monitor_state.json")

    if not os.path.exists(state_path):
        return jsonify({
            "ok": True,
            "last_refresh": None,
            "projects": [],
            "note": "monitor_state.json not found yet"
        })

    try:
        with open(state_path, "r", encoding="utf-8") as f:
            state = json.load(f)
    except Exception as e:
        return jsonify({
            "ok": True,
            "last_refresh": None,
            "projects": [],
            "note": f"load_state_failed: {e.__class__.__name__}"
        })

    return jsonify({
        "ok": True,
        "last_refresh": state.get("last_loop_time"),
        "projects": state.get("projects") or []
    })

# ===== NTX /api/raw Â· æç®€ä¿é™©ç‰ˆ =====
# ä¸åšä»»ä½•å¯†ç æ ¡éªŒï¼Œå…ˆä¿è¯æ¥å£ç¨³å®šè¿”å› JSON
@app.route("/api/raw")
def api_raw_safest():
    import os, json
    from flask import jsonify

    base_dir = os.path.dirname(os.path.abspath(__file__))
    state_path = os.path.join(base_dir, "data", "monitor_state.json")

    if not os.path.exists(state_path):
        return jsonify({
            "ok": True,
            "last_refresh": None,
            "projects": [],
            "note": "monitor_state.json not found yet"
        })

    try:
        with open(state_path, "r", encoding="utf-8") as f:
            state = json.load(f)
    except Exception as e:
        return jsonify({
            "ok": True,
            "last_refresh": None,
            "projects": [],
            "note": "load_state_failed: %s" % e.__class__.__name__
        })

    return jsonify({
        "ok": True,
        "last_refresh": state.get("last_loop_time"),
        "projects": state.get("projects") or []
    })
