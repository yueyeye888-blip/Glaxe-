import io, os

PATH = "/opt/GalxeMonitor/combined_app.py"

if not os.path.exists(PATH):
    print("âŒ æ‰¾ä¸åˆ°", PATH)
    raise SystemExit(1)

with io.open(PATH, "r", encoding="utf-8") as f:
    src = f.readlines()

start = None
end = None

# ä»¥ @app.route("/manage") ä¸ºé”šç‚¹ï¼Œæ•´å—æ›¿æ¢
for i, line in enumerate(src):
    if line.strip().startswith('@app.route("/manage"'):
        start = i
        break

if start is None:
    print("âŒ æ–‡ä»¶é‡Œæ²¡æœ‰æ‰¾åˆ° @app.route(\"/manage\")ï¼Œä¸åšä¿®æ”¹")
    raise SystemExit(1)

for j in range(start + 1, len(src)):
    if src[j].startswith('@app.route("'):
        end = j
        break

if end is None:
    end = len(src)

new_block = [
'@app.route("/manage")\n',
'def manage():\n',
'    """é¡¹ç›®ç®¡ç†é¡µé¢ï¼šæ·±è‰² UI + è¡¨æ ¼ + æ·»åŠ /åˆ é™¤æ“ä½œ"""\n',
'    cfg = load_config()\n',
'    pwd = request.args.get("pwd", "")\n',
'    if pwd != cfg.get("webui_password"):\n',
'        return "Unauthorized", 401\n',
'\n',
'    rows = ""\n',
'    for i, p in enumerate(cfg.get("projects", [])):\n',
'        rows += "<tr>" \\\n',
'                 f"<td>{i}</td>" \\\n',
'                 f"<td>{p.get(\'name\', \'\')}</td>" \\\n',
'                 f"<td>{p.get(\'alias\', \'\')}</td>" \\\n',
'                 f"<td>{p.get(\'category\', \'custom\')}</td>" \\\n',
'                 "</tr>"\n',
'\n',
'    if not rows:\n',
'        rows = "<tr><td colspan=\\"4\\">æš‚æ— é¡¹ç›®ï¼Œè¯·åœ¨ä¸‹æ–¹æ·»åŠ ã€‚</td></tr>"\n',
'\n',
'    html = """\n',
'    <html>\n',
'    <head>\n',
'      <meta charset="utf-8" />\n',
'      <title>Galxe Monitor Â· é¡¹ç›®ç®¡ç†</title>\n',
'      <style>\n',
'        body {{\n',
'          margin: 0;\n',
'          padding: 0;\n',
'          background: #020617;\n',
'          color: #e5e7eb;\n',
'          font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;\n',
'        }}\n',
'        .container {{\n',
'          max-width: 960px;\n',
'          margin: 0 auto;\n',
'          padding: 20px 16px 40px;\n',
'        }}\n',
'        h1 {{\n',
'          margin: 0 0 6px;\n',
'          font-size: 24px;\n',
'        }}\n',
'        .subtitle {{\n',
'          font-size: 13px;\n',
'          color: #9ca3af;\n',
'          margin-bottom: 16px;\n',
'        }}\n',
'        a {{ color:#60a5fa; text-decoration:none; }}\n',
'        a:hover {{ text-decoration:underline; }}\n',
'        .card {{\n',
'          background: radial-gradient(circle at top left,#1f2937 0,#020617 45%);\n',
'          border-radius: 14px;\n',
'          border: 1px solid #111827;\n',
'          padding: 14px 16px 16px;\n',
'          box-shadow: 0 10px 25px rgba(0,0,0,0.45);\n',
'          margin-bottom: 14px;\n',
'        }}\n',
'        .card-header {{\n',
'          display:flex;\n',
'          justify-content:space-between;\n',
'          align-items:center;\n',
'          margin-bottom:10px;\n',
'        }}\n',
'        .card-title {{ font-size:15px; font-weight:600; }}\n',
'        .pill-back {{\n',
'          border-radius:999px;\n',
'          padding:4px 10px;\n',
'          font-size:12px;\n',
'          border:1px solid #374151;\n',
'          background:#020617;\n',
'        }}\n',
'        table {{\n',
'          width: 100%;\n',
'          border-collapse: collapse;\n',
'          font-size: 13px;\n',
'        }}\n',
'        th, td {{\n',
'          border-bottom: 1px solid #1f2937;\n',
'          padding: 6px 8px;\n',
'          text-align: left;\n',
'          white-space: nowrap;\n',
'        }}\n',
'        th {{\n',
'          font-weight:500;\n',
'          color:#9ca3af;\n',
'          background:#020617;\n',
'        }}\n',
'        tr:hover td {{\n',
'          background:#020617;\n',
'        }}\n',
'        .form-row {{\n',
'          display:flex;\n',
'          flex-wrap:wrap;\n',
'          gap:8px;\n',
'          align-items:center;\n',
'          margin-top:8px;\n',
'        }}\n',
'        .form-row label {{\n',
'          font-size:12px;\n',
'          color:#9ca3af;\n',
'        }}\n',
'        .form-row input {{\n',
'          background:#020617;\n',
'          border-radius:999px;\n',
'          border:1px solid #1f2937;\n',
'          padding:5px 10px;\n',
'          color:#e5e7eb;\n',
'          font-size:12px;\n',
'        }}\n',
'        .btn {{\n',
'          border-radius:999px;\n',
'          border:1px solid #4b5563;\n',
'          background:#111827;\n',
'          color:#e5e7eb;\n',
'          padding:6px 12px;\n',
'          font-size:12px;\n',
'          cursor:pointer;\n',
'        }}\n',
'        .btn-primary {{\n',
'          background:#10b981;\n',
'          border-color:#10b981;\n',
'          color:#022c22;\n',
'          font-weight:600;\n',
'        }}\n',
'        .hint {{\n',
'          font-size:11px;\n',
'          color:#9ca3af;\n',
'          margin-top:4px;\n',
'        }}\n',
'        @media (max-width:640px) {{\n',
'          .form-row {{ flex-direction:column; align-items:flex-start; }}\n',
'        }}\n',
'      </style>\n',
'    </head>\n',
'    <body>\n',
'      <div class="container">\n',
'        <h1>é¡¹ç›®ç®¡ç†</h1>\n',
'        <div class="subtitle">\n',
'          åœ¨è¿™é‡Œå¢åˆ ä½ è¦ç›‘æ§çš„ Galxe Spaceã€‚å®Œæˆåè¿”å›ç›‘æ§é¦–é¡µæŸ¥çœ‹æœ€æ–°æ´»åŠ¨ã€‚\n',
'        </div>\n',
'\n',
'        <div class="card">\n',
'          <div class="card-header">\n',
'            <div class="card-title">å½“å‰å·²ç›‘æ§é¡¹ç›®</div>\n',
'            <a class="pill-back" href="/?pwd={pwd}">â† è¿”å›ç›‘æ§é¦–é¡µ</a>\n',
'          </div>\n',
'          <div style="overflow-x:auto;">\n',
'            <table>\n',
'              <tr><th>ç´¢å¼•</th><th>åç§°</th><th>Alias</th><th>åˆ†ç±»</th></tr>\n',
'              {rows}\n',
'            </table>\n',
'          </div>\n',
'        </div>\n',
'\n',
'        <div class="card">\n',
'          <div class="card-header">\n',
'            <div class="card-title">æ·»åŠ é¡¹ç›®</div>\n',
'          </div>\n',
'          <form method="GET" action="/add">\n',
'            <input type="hidden" name="pwd" value="{pwd}">\n',
'            <div class="form-row">\n',
'              <label>åç§°</label>\n',
'              <input name="name" placeholder="ä¾‹å¦‚ï¼šBNB Chain">\n',
'              <label>Alias</label>\n',
'              <input name="alias" placeholder="ä¾‹å¦‚ï¼šbnbchain">\n',
'              <label>åˆ†ç±»</label>\n',
'              <input name="category" value="custom" placeholder="custom æˆ– trending">\n',
'              <button type="submit" class="btn btn-primary">æ·»åŠ </button>\n',
'            </div>\n',
'            <div class="hint">Alias é€šå¸¸å¯ä»¥ä» Galxe Space URL ä¸­çœ‹åˆ°ï¼ˆapp.galxe.com/space/&lt;alias&gt;ï¼‰ã€‚</div>\n',
'          </form>\n',
'        </div>\n',
'\n',
'        <div class="card">\n',
'          <div class="card-header">\n',
'            <div class="card-title">åˆ é™¤é¡¹ç›®</div>\n',
'          </div>\n',
'          <form method="GET" action="/delete">\n',
'            <input type="hidden" name="pwd" value="{pwd}">\n',
'            <div class="form-row">\n',
'              <label>ç´¢å¼•</label>\n',
'              <input name="idx" placeholder="åœ¨ä¸Šè¡¨ä¸­æŸ¥çœ‹ç´¢å¼•ï¼Œä¾‹å¦‚ï¼š0">\n',
'              <button type="submit" class="btn">åˆ é™¤</button>\n',
'            </div>\n',
'            <div class="hint">åˆ é™¤åè‡ªåŠ¨ä¿å­˜ï¼Œæ— éœ€é‡å¯ç¨‹åºã€‚</div>\n',
'          </form>\n',
'        </div>\n',
'      </div>\n',
'    </body>\n',
'    </html>\n',
'    """.format(rows=rows, pwd=cfg["webui_password"])\n',
'\n',
'    return html\n',
]

backup = PATH + ".bak_manage_ui"
with io.open(backup, "w", encoding="utf-8") as f:
    f.writelines(src)

with io.open(PATH, "w", encoding="utf-8") as f:
    f.writelines(src[:start] + new_block + src[end:])

print("âœ… /manage é¡µé¢ UI å·²æ›¿æ¢ä¸ºæ·±è‰²å¡ç‰‡ç‰ˆ")
print("ğŸ“¦ æ—§ç‰ˆæœ¬å·²å¤‡ä»½åˆ°:", backup)
