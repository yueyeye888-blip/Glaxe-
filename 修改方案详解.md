# TG æ¨é€æœºåˆ¶ä¼˜åŒ–æ–¹æ¡ˆ - è¯¦ç»†æ”¹åŠ¨è¯´æ˜

## ğŸ¯ éœ€æ±‚æ€»ç»“

å½“å‰é—®é¢˜ï¼š
1. æ‰¹é‡æ·»åŠ é¡¹ç›®åï¼Œæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„é¡¹ç›®ä¼šä¸€æ¬¡æ€§å…¨éƒ¨æ¨é€
2. éœ€è¦æ”¹ä¸ºï¼šæ¯ 30 åˆ†é’Ÿæ¨é€ä¸€ä¸ªé¡¹ç›®ï¼Œæ¯ä¸ªæ´»åŠ¨åªæ¨é€ä¸€æ¬¡

## ğŸ“‹ å…·ä½“æ”¹åŠ¨

### æ”¹åŠ¨ 1: æ·»åŠ å…¨å±€å˜é‡ï¼ˆç¬¬ ~52 è¡Œåï¼‰

**ä½ç½®**: `/root/GalxeMonitor/src/app.py` ç¬¬ 52-54 è¡Œ

**åŸä»£ç **:
```python
monitor_state = {"last_loop": "", "projects": []}
last_notified = {}  # alias -> last campaign id
```

**æ–°ä»£ç **:
```python
monitor_state = {"last_loop": "", "projects": []}
last_notified = {}  # alias -> last campaign id
push_queue = []  # å¾…æ¨é€é˜Ÿåˆ—: [(alias, name, latest, url, timestamp), ...]
push_queue_lock = threading.Lock()  # é˜Ÿåˆ—çº¿ç¨‹é”
last_push_time = 0  # ä¸Šæ¬¡æ¨é€çš„æ—¶é—´æˆ³
push_interval = 30 * 60  # æ¨é€é—´éš”ï¼š30 åˆ†é’Ÿ
```

---

### æ”¹åŠ¨ 2: æ–°å¢é˜Ÿåˆ—ç®¡ç†å‡½æ•°ï¼ˆç¬¬ ~600 è¡Œï¼‰

**ä½ç½®**: `send_notifications()` å‡½æ•°åé¢ï¼Œ`start_monitor()` å‡½æ•°å‰

**æ–°å¢å‡½æ•°**:

```python
def load_push_queue():
    """ä»æ–‡ä»¶åŠ è½½æ¨é€é˜Ÿåˆ—"""
    global push_queue
    queue_file = os.path.join(ROOT, "data", "push_queue.json")
    try:
        if os.path.exists(queue_file):
            with open(queue_file, "r", encoding="utf-8") as f:
                data = json.load(f)
                push_queue = data.get("queue", [])
                logger.info(f"å·²æ¢å¤æ¨é€é˜Ÿåˆ—ï¼Œå…± {len(push_queue)} ä¸ªå¾…æ¨é€é¡¹ç›®")
    except Exception as e:
        logger.error(f"åŠ è½½æ¨é€é˜Ÿåˆ—å¤±è´¥: {e}")

def save_push_queue():
    """ä¿å­˜æ¨é€é˜Ÿåˆ—åˆ°æ–‡ä»¶"""
    global push_queue
    queue_file = os.path.join(ROOT, "data", "push_queue.json")
    try:
        with open(queue_file, "w", encoding="utf-8") as f:
            json.dump({
                "queue": push_queue,
                "timestamp": time.time()
            }, f, indent=2, ensure_ascii=False)
    except Exception as e:
        logger.error(f"ä¿å­˜æ¨é€é˜Ÿåˆ—å¤±è´¥: {e}")

def add_to_push_queue(cfg, project_name, alias, latest, url):
    """æ·»åŠ é¡¹ç›®åˆ°æ¨é€é˜Ÿåˆ—"""
    global push_queue
    with push_queue_lock:
        # æ£€æŸ¥æ˜¯å¦å·²åœ¨é˜Ÿåˆ—ä¸­
        for item in push_queue:
            if item["alias"] == alias and item["latest"].get("id") == latest.get("id"):
                logger.debug(f"é¡¹ç›®å·²åœ¨é˜Ÿåˆ—ä¸­: {alias}")
                return
        
        push_queue.append({
            "alias": alias,
            "project_name": project_name,
            "latest": latest,
            "url": url,
            "timestamp": time.time()
        })
        save_push_queue()
        logger.info(f"âœ… [{project_name}] å·²åŠ å…¥æ¨é€é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—å¤§å°: {len(push_queue)}")

def process_push_queue():
    """å¤„ç†æ¨é€é˜Ÿåˆ—çº¿ç¨‹ï¼ˆæ¯ 30 åˆ†é’Ÿæ¨é€ä¸€ä¸ªï¼‰"""
    global push_queue, last_push_time
    
    logger.info("æ¨é€é˜Ÿåˆ—å¤„ç†å™¨å·²å¯åŠ¨")
    
    while True:
        try:
            now = time.time()
            
            # æ£€æŸ¥æ˜¯å¦è¯¥æ¨é€ï¼ˆé—´éš” >= 30 åˆ†é’Ÿï¼‰
            if now - last_push_time >= push_interval and push_queue:
                with push_queue_lock:
                    if push_queue:  # å†æ£€æŸ¥ä¸€æ¬¡
                        item = push_queue.pop(0)
                        last_push_time = now
                        save_push_queue()
                        
                        # æ‰§è¡Œæ¨é€
                        cfg = load_config()
                        project_name = item["project_name"]
                        alias = item["alias"]
                        latest = item["latest"]
                        url = item["url"]
                        
                        try:
                            # å†æ¬¡æ£€æŸ¥ should_notifyï¼ˆä»¥é˜²æ´»åŠ¨å·²è¿‡æœŸï¼‰
                            if should_notify(latest):
                                send_notifications(cfg, project_name, alias, latest, url)
                                logger.info(f"âœ… ä»é˜Ÿåˆ—æ¨é€: [{project_name}] - å‰©ä½™ {len(push_queue)} ä¸ªå¾…æ¨é€")
                            else:
                                logger.info(f"â­ï¸ é˜Ÿåˆ—é¡¹å·²è¿‡æœŸï¼ˆä¸ç¬¦åˆæ¨é€æ¡ä»¶ï¼‰: {project_name}")
                        except Exception as e:
                            logger.error(f"é˜Ÿåˆ—æ¨é€å¤±è´¥: {e}")
            
            # æ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
            time.sleep(5 * 60)
            
        except Exception as e:
            logger.error(f"æ¨é€é˜Ÿåˆ—å¤„ç†å™¨å¼‚å¸¸: {e}")
            time.sleep(60)
```

---

### æ”¹åŠ¨ 3: ä¿®æ”¹ `monitor_loop` å‡½æ•°ï¼ˆç¬¬ ~560-590 è¡Œï¼‰

**åŸä»£ç **ï¼ˆç¬¬ 585 è¡Œï¼‰:
```python
                if not first_loop and cid and latest:
                    prev = last_notified.get(alias)
                    if prev != cid:
                        send_notifications(cfg, name, alias, latest, url)
                        last_notified[alias] = cid
```

**æ–°ä»£ç **:
```python
                if not first_loop and cid and latest:
                    prev = last_notified.get(alias)
                    if prev != cid:
                        # æ”¹ä¸ºæ·»åŠ åˆ°é˜Ÿåˆ—è€Œä¸æ˜¯ç›´æ¥æ¨é€
                        add_to_push_queue(cfg, name, alias, latest, url)
                        last_notified[alias] = cid
```

---

### æ”¹åŠ¨ 4: å¯åŠ¨æ¨é€çº¿ç¨‹ï¼ˆç¬¬ ~601 è¡Œ `start_monitor()` å‡½æ•°å†…ï¼‰

**åŸä»£ç **:
```python
def start_monitor():
    """å¯åŠ¨ç›‘æ§çº¿ç¨‹"""
    monitor_thread = threading.Thread(target=monitor_loop, daemon=True)
    monitor_thread.start()
    logger.info("ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨")
```

**æ–°ä»£ç **:
```python
def start_monitor():
    """å¯åŠ¨ç›‘æ§çº¿ç¨‹"""
    # æ¢å¤æ¨é€é˜Ÿåˆ—
    load_push_queue()
    
    # å¯åŠ¨ç›‘æ§çº¿ç¨‹
    monitor_thread = threading.Thread(target=monitor_loop, daemon=True)
    monitor_thread.start()
    logger.info("ç›‘æ§çº¿ç¨‹å·²å¯åŠ¨")
    
    # å¯åŠ¨æ¨é€é˜Ÿåˆ—å¤„ç†å™¨
    push_scheduler = threading.Thread(target=process_push_queue, daemon=True)
    push_scheduler.start()
    logger.info("æ¨é€é˜Ÿåˆ—å¤„ç†å™¨å·²å¯åŠ¨ï¼ˆæ¯ 30 åˆ†é’Ÿæ¨é€ä¸€ä¸ªé¡¹ç›®ï¼‰")
```

---

## ğŸ“Š è¿è¡Œæµç¨‹å›¾

```
ã€ç¬¬ä¸€æ¬¡å¾ªç¯ã€‘
ç›‘æ§ â†’ å‘ç°æ–°é¡¹ç›® A
â†’ ä¸æ¨é€ï¼Œæ·»åŠ åˆ°é˜Ÿåˆ—
â†’ é˜Ÿåˆ—: [A]

ã€ç¬¬äºŒæ¬¡å¾ªç¯ã€‘
ç›‘æ§ â†’ å‘ç°æ–°é¡¹ç›® B
â†’ ä¸æ¨é€ï¼Œæ·»åŠ åˆ°é˜Ÿåˆ—  
â†’ é˜Ÿåˆ—: [A, B]

ã€æ¨é€çº¿ç¨‹ã€‘
ç­‰å¾… 30 åˆ†é’Ÿ
â†’ å¼¹å‡ºé¡¹ç›® A
â†’ æ¨é€ A
â†’ é˜Ÿåˆ—: [B]

ã€ç¬¬ä¸‰æ¬¡å¾ªç¯ã€‘
ç›‘æ§ â†’ å‘ç°æ–°é¡¹ç›® C
â†’ ä¸æ¨é€ï¼Œæ·»åŠ åˆ°é˜Ÿåˆ—
â†’ é˜Ÿåˆ—: [B, C]

ã€æ¨é€çº¿ç¨‹ã€‘
ç­‰å¾… 30 åˆ†é’Ÿ
â†’ å¼¹å‡ºé¡¹ç›® B
â†’ æ¨é€ B
â†’ é˜Ÿåˆ—: [C]
```

---

## âœ… æ•ˆæœ

- âœ… æ‰¹é‡æ·»åŠ é¡¹ç›®åï¼Œä¸ä¼šä¸€æ¬¡æ€§æ¨é€å…¨éƒ¨
- âœ… æ¯ 30 åˆ†é’Ÿè‡ªåŠ¨æ¨é€é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªé¡¹ç›®
- âœ… æ¯ä¸ªæ´»åŠ¨åªæ¨é€ä¸€æ¬¡ï¼ˆlast_notified æ§åˆ¶ï¼‰
- âœ… æœåŠ¡å™¨é‡å¯æ—¶é˜Ÿåˆ—ä¸ä¸¢å¤±ï¼ˆå­˜å‚¨åˆ°æ–‡ä»¶ï¼‰
- âœ… é˜Ÿåˆ—ä¸­çš„é¡¹ç›®æŒ‰é¡ºåºæ¨é€ï¼ˆFIFOï¼‰

---

## ğŸ”§ å¦‚ä½•è°ƒæ•´æ¨é€é—´éš”ï¼Ÿ

å¦‚æœè¦æ”¹æˆå…¶ä»–æ—¶é—´é—´éš”ï¼ˆæ¯”å¦‚ 15 åˆ†é’Ÿã€1 å°æ—¶ï¼‰ï¼Œä¿®æ”¹å…¨å±€å˜é‡ï¼š

```python
push_interval = 15 * 60  # æ”¹ä¸º 15 åˆ†é’Ÿ
push_interval = 60 * 60  # æ”¹ä¸º 1 å°æ—¶
push_interval = 2 * 60   # æ”¹ä¸º 2 åˆ†é’Ÿï¼ˆæµ‹è¯•ç”¨ï¼‰
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨ `push_queue_lock` é˜²æ­¢å¹¶å‘è®¿é—®å†²çª
2. **æŒä¹…åŒ–**: æ¯æ¬¡æ”¹åŠ¨é˜Ÿåˆ—éƒ½ä¼šä¿å­˜åˆ° `data/push_queue.json`
3. **æ—¶é—´æ£€æŸ¥**: æ¨é€å‰ä¼šå†æ¬¡æ£€æŸ¥ `should_notify()`ï¼Œç¡®ä¿æ´»åŠ¨æœªè¿‡æœŸ
4. **å®¹é”™**: å¦‚æœæ¨é€å¤±è´¥ï¼Œé¡¹ç›®å·²ä»é˜Ÿåˆ—ç§»é™¤ï¼ˆå¯é€‰æ”¹è¿›ï¼šå¤±è´¥é‡è¯•ï¼‰

