# 📋 GalxeMonitor 推送队列系统 - 快速参考卡

## ⚡ 常用命令

```bash
# 查看进程状态
ps aux | grep "python3 src/app.py" | grep -v grep

# 查看队列大小
wc -l /root/GalxeMonitor/data/push_queue.json

# 查看最新日志（20行）
tail -20 /root/GalxeMonitor/logs/app.log

# 查看关键日志
tail -100 /root/GalxeMonitor/logs/app.log | grep -E "推送|队列|启动|ERROR"

# 重启服务
pkill -f "python3 src/app.py"
cd /root/GalxeMonitor && nohup python3 src/app.py > logs/app.log 2>&1 &

# 清空队列
rm /root/GalxeMonitor/data/push_queue.json

# 查看队列内容（前100行）
head -100 /root/GalxeMonitor/data/push_queue.json | jq '.'
```

---

## 📊 系统监控

**使用本地监控脚本**:
```bash
# 快速检查
python3 /Users/xingxiu/monitor_queue.py quick

# 实时监控（每分钟更新）
python3 /Users/xingxiu/monitor_queue.py
```

---

## 🎯 核心参数

| 参数 | 值 | 位置 |
|------|-----|------|
| 推送间隔 | 1800 秒 (30分钟) | app.py 全局变量 |
| 监控周期 | 30 秒 | monitor_loop 中 |
| 队列检查 | 60 秒 | process_push_queue 中 |
| 项目数 | 372 | config.json |
| 推送方式 | Telegram | notify_method |
| Bot Token | 8331180504:AAFU-... | config.json |
| Chat ID | -1002512291367 | config.json |

---

## 📈 性能指标

| 指标 | 当前值 |
|------|--------|
| CPU | ~1% |
| 内存 | ~38 MB |
| 队列大小 | 0-6000+ 行 |
| 推送延迟 | 最多 30 分钟 |
| 队列文件 | ~187 KB |

---

## 🔍 文件位置

```
/root/GalxeMonitor/
├── src/
│   └── app.py ........................ 主程序 (1587 行)
├── config_files/
│   └── config.json .................. 配置 (372 项目)
├── data/
│   ├── push_queue.json .............. 推送队列 (持久化)
│   └── monitor_state.json ........... 监控状态
└── logs/
    └── app.log ...................... 日志文件 (55+ MB)
```

---

## 🚀 启动流程

1. **加载持久化队列** → `load_push_queue()`
2. **启动监控线程** → 每30秒扫描一次
3. **启动队列线程** → 每30分钟推送一个项目
4. **启动Web服务** → 监听 :5001 端口

---

## ✅ 检查清单

启动后确认:
- [ ] 进程运行: `ps aux | grep app.py`
- [ ] 日志生成: `tail -f logs/app.log`
- [ ] 队列存在: `ls -l data/push_queue.json`
- [ ] 无错误: `tail -50 logs/app.log | grep ERROR`

---

## 🔑 关键函数

```python
# 1. 加载队列
load_push_queue()

# 2. 添加到队列
add_to_push_queue(space_id, activity_id, name)

# 3. 处理队列（后台线程）
process_push_queue()

# 4. 保存队列
save_push_queue()
```

---

## 📊 数据结构

### 推送队列项
```json
{
  "space_id": "okxweb3",
  "activity_id": "act_12345",
  "title": "OKX Web3 Wallet",
  "added_time": 1700578123
}
```

### 队列文件格式
```json
[
  { "space_id": "...", "activity_id": "...", ... },
  { "space_id": "...", "activity_id": "...", ... },
  ...
]
```

---

## 🎯 推送流程

```
监控检测 ─→ 添加队列 ─→ 等待30分钟 ─→ 推送TG ─→ 更新状态
  (30s)      (即时)       (1800s)      (瞬间)     (即时)
```

---

## 💬 FAQ

**Q: 为什么没有立即推送?**  
A: 设计特性，首次推送需等待最多30分钟

**Q: 队列会不会无限增长?**  
A: 会，除非停止监控或清空队列

**Q: 如何改变推送频率?**  
A: 修改 app.py 中 `push_interval = 1800` 为其他值

**Q: 重启后队列会丢失吗?**  
A: 不会，队列持久化到 push_queue.json

**Q: 如何验证 TG 推送?**  
A: 查看日志: `grep "Telegram" logs/app.log`

---

## 🆘 常见问题

| 问题 | 原因 | 解决 |
|------|------|------|
| 进程不运行 | 崩溃或未启动 | 查看日志，重新启动 |
| 队列不生成 | 无新活动 | 正常现象，等待新活动 |
| TG不推送 | 配置错误 | 检查 bot_token 和 chat_id |
| 日志乱码 | 编码问题 | 使用 `iconv` 转换编码 |

---

## 🔧 高级操作

### 修改推送间隔
```bash
# 改为10分钟 (600秒)
sed -i 's/push_interval = 1800/push_interval = 600/' /root/GalxeMonitor/src/app.py
```

### 导出队列
```bash
cat /root/GalxeMonitor/data/push_queue.json | jq '.' > queue_backup.json
```

### 统计队列中的项目
```bash
cat /root/GalxeMonitor/data/push_queue.json | jq 'group_by(.space_id) | map({space_id: .[0].space_id, count: length})'
```

---

## 📞 快速求助

**系统不启动?**
```bash
# 1. 检查语法错误
python3 -m py_compile /root/GalxeMonitor/src/app.py

# 2. 查看详细错误
python3 /root/GalxeMonitor/src/app.py
```

**队列堆积?**
```bash
# 1. 查看队列大小
wc -l /root/GalxeMonitor/data/push_queue.json

# 2. 加快推送（改为5分钟）
sed -i 's/push_interval = 1800/push_interval = 300/' /root/GalxeMonitor/src/app.py
pkill -f "python3 src/app.py" && sleep 2
cd /root/GalxeMonitor && nohup python3 src/app.py > logs/app.log 2>&1 &
```

---

## 📌 重要信息

- **服务器**: 47.76.90.4 (Aliyun ECS)
- **项目数**: 372 个
- **推送方式**: Telegram
- **队列位置**: `/root/GalxeMonitor/data/push_queue.json`
- **实施日期**: 2025-11-21
- **状态**: ✅ 运行中

---

**最后更新**: 2025-11-21 02:09 UTC+8
