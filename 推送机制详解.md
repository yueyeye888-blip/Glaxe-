# TG 群推送机制 - 完整流程分析

## 📊 推送流程图

```
监控循环 (每30秒执行一次)
    ↓
遍历所有项目 (config.json 中的 projects)
    ↓
从 Galxe OpenAPI 获取该项目的最新活动
    ↓
提取活动 ID (cid = extract_campaign_id(latest))
    ↓
比较: 本次的 cid 是否与上次推送的 cid 相同？
    ├─ 【相同】→ 跳过，不推送（已推送过）
    ├─ 【不同】或【首次检测】→ 进入推送检查
    ↓
调用 send_notifications() 函数
    ↓
【第一道检查】notify_method 是否启用？
    ├─ notify_method = "none" → ❌ 跳过推送（当前状态）
    ├─ notify_method = "telegram" → ✅ 继续
    ├─ notify_method = "discord" → ✅ 继续
    ├─ notify_method = "both" → ✅ 继续
    ↓
【第二道检查】调用 should_notify(latest) 判断活动是否符合推送条件
    ↓
活动是否满足以下 3 个条件？
    ├─ 条件1: 活动未来时间 ≥ 现在 (活动还没结束)
    ├─ 条件2: 活动结束时间 ≤ 现在 + 60天 (不推送太久远的活动)
    ├─ 条件3: 如果活动已开始，从开始到现在 ≤ 30天 (不推送太旧的活动)
    ↓
    如果 【全部满足】→ ✅ 推送
    如果 【任意不满足】→ ❌ 跳过推送
    ↓
生成推送文本 (build_notify_text)
    ↓
发送到 Telegram/Discord
    ↓
记录本次活动 ID (last_notified[alias] = cid)
```

---

## ⚙️ 详细推送条件

### 【必要条件 1】notify_method 必须启用
```python
method = (cfg.get("notify_method") or "none").lower()

if method == "none":
    return  # ❌ 停止推送
```

**当前状态**: ❌ 禁用（notify_method = "none"）

---

### 【必要条件 2】活动必须是新发现的
```python
cid = extract_campaign_id(latest)  # 提取活动 ID
if not first_loop and cid and latest:
    prev = last_notified.get(alias)
    if prev != cid:  # ✅ 新活动才推送
        send_notifications(...)
        last_notified[alias] = cid
```

**含义**:
- 只有当活动 ID 与上次不同时才推送
- 同一个活动 ID 不会重复推送
- 首次循环（first_loop=True）不推送任何东西

---

### 【必要条件 3】should_notify() - 活动时间必须符合条件

#### 条件 3.1: 活动必须还没结束
```python
now = datetime.now(timezone.utc)
end_time = parse_timestamp(latest.get("endTime"))

if now > end_time:  # ❌ 活动已过期
    logger.debug("跳过推送 - 活动已结束")
    return False
```

#### 条件 3.2: 活动结束时间必须在 60 天内
```python
days_until_end = (end_time - now).days

if days_until_end > 60:  # ❌ 太久远的活动
    logger.debug(f"跳过推送 - 活动结束时间太远({days_until_end}天后)")
    return False
```

#### 条件 3.3: 活动开始时间不能太早（超过 30 天前）
```python
start_time = parse_timestamp(latest.get("startTime"))

if now > start_time:  # 活动已开始
    days_since_start = (now - start_time).days
    
    if days_since_start > 30:  # ❌ 活动太旧
        logger.debug(f"跳过推送 - 活动开始时间太久({days_since_start}天前)")
        return False
```

---

## 📝 推送时间窗口总结

活动必须满足以下时间条件才会被推送到 TG 群:

```
时间轴图示:

<-- 30天前 -->|<-- 现在 -->|<-- 60天后 -->
              ↑            ↑              ↑
           不推送    【推送窗口】      不推送
           (太旧)                      (太远)

推送窗口:
- 活动最早开始时间: 现在 - 30天
- 活动最晚结束时间: 现在 + 60天
- 活动必须还未结束
```

### 实际例子

| 场景 | startTime | endTime | 现在 | 是否推送？ | 原因 |
|------|-----------|---------|------|----------|------|
| 例1 | 2025-11-20 | 2025-11-22 | 2025-11-21 | ✅ 是 | 进行中，在窗口内 |
| 例2 | 2025-11-19 | 2025-12-01 | 2025-11-21 | ✅ 是 | 进行中，在窗口内 |
| 例3 | 2025-12-01 | 2026-01-31 | 2025-11-21 | ✅ 是 | 未开始，41天后，在窗口内 |
| 例4 | 2025-09-20 | 2025-11-20 | 2025-11-21 | ❌ 否 | 已结束（超过end_time） |
| 例5 | 2025-08-20 | 2025-09-20 | 2025-11-21 | ❌ 否 | 已结束+已过期 |
| 例6 | 2025-09-01 | 2026-02-01 | 2025-11-21 | ❌ 否 | 开始于81天前（超过30天） |
| 例7 | 2025-10-01 | 2026-02-01 | 2025-11-21 | ✅ 是 | 开始于51天前，但结束时间在60天内 |
| 例8 | 2025-11-20 | 2026-03-01 | 2025-11-21 | ✅ 是 | 开始于1天前，结束时间在窗口内 |

---

## 🔔 推送文本格式

当条件都满足后，会生成如下格式的消息推送到 TG 群:

```
✅ 状态: ⏳ 未开始
📊 项目: BNB Chain
🆔 Alias: bnbchain
📢 活动: Galxe Official Quest Vol.15

⏰ 开始: 2025-11-22 10:00:00
⏰ 结束: 2025-11-29 18:00:00

🔗 立即参与 Galxe 任务 (点击链接)

━━━━━━━━━━━━━━━
💡 由 NTX 社区提供
```

---

## 🎯 当前为什么没有推送

### 根本原因:

1. **notify_method = "none"** ← 推送被禁用
   - 即使活动完全符合条件，也会在【必要条件 1】被停止

2. **大多数项目无法获取数据** (OpenAPI 错误)
   - fetch_latest() 返回 None
   - should_notify() 检查不到有效的 startTime/endTime
   - 导致 latest 为空，无法推送

3. **Telegram 凭证未配置**
   - 即使启用推送，也无法发送（没有 token 和 chat_id）

---

## 💡 要启动推送需要做的事

### Step 1: 启用通知
```
config.json: "notify_method": "telegram"  (改成 telegram 或 discord 或 both)
```

### Step 2: 配置 Telegram
```
config.json: "telegram_bot_token": "YOUR_BOT_TOKEN"
config.json: "telegram_chat_id": "YOUR_CHAT_ID"
```

### Step 3: 验证项目别名
```
确保 config.json 中的 projects[].alias 与 Galxe 实际的 space alias 一致
```

---

## 📌 关键代码位置

| 流程步骤 | 函数名 | 文件 | 行号 |
|--------|-------|------|------|
| 监控循环 | monitor_loop() | app.py | 560-600 |
| 推送决策 | send_notifications() | app.py | 529-545 |
| 时间检查 | should_notify() | app.py | 482-528 |
| 状态判断 | build_status() | app.py | 287-310 |
| 文本生成 | build_notify_text() | app.py | 376-405 |
| TG 发送 | send_telegram() | app.py | 431-466 |

